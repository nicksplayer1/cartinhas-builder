 <!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Construtor de Cartinhas</title>

  <style>
    :root{
      --bg:#0b1020;
      --panel: rgba(20,20,30,.55);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --r: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1100px 800px at 25% 20%, #24346b 0%, transparent 60%),
        radial-gradient(1000px 750px at 80% 25%, #6b235e 0%, transparent 55%),
        linear-gradient(135deg, #0b1020, #111a33);
      min-height:100vh;
    }
    header{
      padding:18px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; flex-direction:column; gap:4px;}
    .brand h1{margin:0; font-size:16px;}
    .brand p{margin:0; font-size:12px; color:var(--muted)}
    .bar{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}

    .wrap{
      padding: 0 18px 18px;
      display:grid;
      grid-template-columns: 390px 1fr;
      gap:14px;
    }
    .card{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .card-h{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .card-h .t{font-size:13px; color:var(--text); opacity:.95}
    .card-b{padding:12px}

    .themes{display:grid; grid-template-columns: 1fr; gap:10px;}
    .theme{
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      display:flex; gap:10px; align-items:flex-start;
      transition: .15s ease;
    }
    .theme:hover{ background: rgba(0,0,0,.26); }
    .theme.active{
      border-color: rgba(255,255,255,.25);
      background: rgba(255,255,255,.08);
    }
    .emoji{font-size:22px; width:32px; text-align:center}
    .theme .name{font-size:13px; margin:0}
    .theme .desc{font-size:12px; color:var(--muted); margin:4px 0 0}

    label{font-size:12px; color:var(--muted)}
    input, textarea{
      width:100%;
      margin-top:6px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding:10px 12px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height: 110px; resize:vertical;}
    .grid{display:grid; gap:10px;}
    .btn{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding:10px 12px;
      cursor:pointer;
      font-size:13px;
      display:inline-flex; gap:8px; align-items:center;
      text-decoration:none;
    }
    .btn:hover{ background: rgba(255,255,255,.14); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .hint{font-size:12px; color:var(--muted); line-height:1.45}
    .sep{height:1px; background: rgba(255,255,255,.10); margin:12px 0;}

    .preview{
      height: calc(100vh - 100px);
      width:100%;
      border:0;
      border-radius: 16px;
      background: rgba(0,0,0,.15);
    }

    .empty{
      padding:16px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.18);
      color:rgba(255,255,255,.75);
      background: rgba(0,0,0,.12);
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      place-items:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(720px, 100%);
      border-radius: 18px;
      background: rgba(20,20,30,.82);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .modalH{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .modalB{padding:14px;}
    .rowBtns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .linkBox{
      width:100%;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      font-size:13px;
      word-break: break-all;
      white-space: pre-wrap;
    }

    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr; }
      .preview{height: 70vh;}
    }
  </style>

  <!-- libs para ZIP -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>

<body>
  <header>
    <div class="brand">
      <h1>üíå Construtor de Cartinhas</h1>
      <p>Escolha um tema, escreva. Depois pague e gere um link (Pix) ou exporte ZIP.</p>
    </div>
    <div class="bar">
      <button class="btn" id="btnPay" disabled>üí≥ Pagar R$ 4,90 e gerar link</button>
      <button class="btn" id="btnExport" disabled>‚¨áÔ∏è Exportar ZIP</button>
      <button class="btn" id="btnDiag">üß™ Testar /api/publish (diagn√≥stico)</button>
    </div>
  </header>

  <div class="wrap">
    <!-- LEFT -->
    <div class="card">
      <div class="card-h">
        <div class="t">üé≠ Temas</div>
        <div class="hint">Toque em um tema pra abrir e editar.</div>
      </div>
      <div class="card-b">
        <div class="themes" id="themes"></div>

        <div class="sep"></div>

        <!-- Painel que s√≥ aparece quando escolher tema -->
        <div id="editor" style="display:none;">
          <div class="hint" id="themeHint" style="margin-bottom:10px;"></div>
          <div class="grid" id="form"></div>
          <div class="hint" style="margin-top:10px;">
            No celular: escolha a foto e aguarde carregar. Se n√£o aparecer no preview, troque e tente de novo.
          </div>
        </div>

        <div id="pickTheme" class="empty">
          üëÜ Escolha um tema acima pra come√ßar.
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="card-h">
        <div class="t">üëÄ Preview</div>
        <div class="hint">Atualiza automaticamente</div>
      </div>
      <div class="card-b">
        <iframe class="preview" id="preview" sandbox="allow-same-origin allow-scripts"></iframe>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalH">
        <div style="font-size:13px;" id="modalTitle">‚úÖ</div>
        <button class="btn" id="btnCloseModal">‚úñÔ∏è Fechar</button>
      </div>
      <div class="modalB">
        <div class="hint" id="modalHint"></div>
        <div class="linkBox" id="modalLink" style="margin-top:10px; display:none;"></div>
        <div class="rowBtns" id="modalBtns"></div>
      </div>
    </div>
  </div>

<script>
  // =============================
  // Config
  // =============================
  const PRICE_LABEL = "R$ 4,90";

  // =============================
  // Helpers
  // =============================
  const $ = (s) => document.querySelector(s);

  function escHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (m)=>( {
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m] ));
  }
  function escAttr(s){
    return String(s ?? "").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }
  function safeName(name){
    return String(name || "imagem.jpg").replace(/[^\w.\-]+/g, "_");
  }
  function readFileAsDataURL(file){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = () => resolve(String(r.result));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  function makeField(field, value, onChange){
    const wrap = document.createElement("div");
    const id = "f_" + field.key;

    wrap.innerHTML = `<label for="${id}">${escHtml(field.label)}</label>`;

    let el;
    if(field.type === "textarea"){
      el = document.createElement("textarea");
      el.id = id;
      el.value = value ?? "";
      if(field.placeholder) el.placeholder = field.placeholder;
    } else if(field.type === "file"){
      el = document.createElement("input");
      el.id = id;
      el.type = "file";
      el.accept = field.accept || "";
    } else {
      el = document.createElement("input");
      el.id = id;
      el.type = "text";
      el.value = value ?? "";
      if(field.placeholder) el.placeholder = field.placeholder;
    }

    el.addEventListener("input", () => onChange(field, el));
    el.addEventListener("change", () => onChange(field, el));
    wrap.appendChild(el);

    if(field.help){
      const h = document.createElement("div");
      h.className = "hint";
      h.style.marginTop = "6px";
      h.textContent = field.help;
      wrap.appendChild(h);
    }

    return wrap;
  }

  function openModal({ title, hint, linkText, buttons }){
    $("#modalTitle").textContent = title || "‚úÖ";
    $("#modalHint").textContent = hint || "";
    const linkBox = $("#modalLink");
    const btns = $("#modalBtns");

    btns.innerHTML = "";

    if(linkText){
      linkBox.style.display = "block";
      linkBox.textContent = linkText;
    } else {
      linkBox.style.display = "none";
      linkBox.textContent = "";
    }

    (buttons || []).forEach(b=>{
      if(b.type === "a"){
        const a = document.createElement("a");
        a.className = "btn";
        a.textContent = b.label;
        a.href = b.href || "#";
        a.target = b.target || "_blank";
        a.rel = "noopener";
        btns.appendChild(a);
      } else {
        const bt = document.createElement("button");
        bt.className = "btn";
        bt.textContent = b.label;
        bt.onclick = b.onClick;
        btns.appendChild(bt);
      }
    });

    $("#modalBack").style.display = "grid";
  }
  function closeModal(){
    $("#modalBack").style.display = "none";
  }

  $("#btnCloseModal").addEventListener("click", closeModal);
  $("#modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") closeModal(); });

  // L√™ texto do response e tenta JSON (pra n√£o "sumir" o erro)
  async function readResponseSmart(res){
    const text = await res.text();
    let json = null;
    try { json = JSON.parse(text); } catch {}
    return { text, json };
  }
  function pretty(obj){
    try { return JSON.stringify(obj, null, 2); } catch { return String(obj); }
  }

  // =============================
  // Temas
  // =============================
  const THEMES = {
    amor: {
      emoji: "üíå",
      name: "Cartinha de Amor",
      desc: "Carta glass + foto opcional.",
      hint: "Ideal pra mandar por link (ap√≥s pagamento Pix) ou exportar ZIP (offline).",
      fields: [
        { key:"title", label:"T√≠tulo", placeholder:"Uma cartinha pra voc√™ ‚ù§Ô∏è" },
        { key:"to", label:"Para", placeholder:"Meu amor" },
        { key:"message", label:"Mensagem", type:"textarea", placeholder:"Escreva aqui sua mensagem..." },
        { key:"from", label:"Assinatura", placeholder:"Seu nome" },
        { key:"photo", label:"Foto (opcional)", type:"file", accept:"image/*", help:"Aparece no topo da cartinha." }
      ],
      generate: (data, asset, mode) => genCartinhaGlass(data, asset, mode)
    },

    simples: {
      emoji: "‚úâÔ∏è",
      name: "Cartinha Simples",
      desc: "Sem foto, s√≥ texto (bem direto).",
      hint: "Perfeita pra algo r√°pido.",
      fields: [
        { key:"title", label:"T√≠tulo", placeholder:"Oi, vim deixar isso aqui..." },
        { key:"to", label:"Para", placeholder:"Fulano/Fulana" },
        { key:"message", label:"Mensagem", type:"textarea", placeholder:"Escreva aqui..." },
        { key:"from", label:"Assinatura", placeholder:"Seu nome" }
      ],
      generate: (data) => genCartinhaSimples(data)
    }
  };

  // =============================
  // Estado
  // =============================
  let themeId = null;

  const state = {
    amor: {
      title: "Uma cartinha pra voc√™ ‚ù§Ô∏è",
      to: "Meu amor",
      message: "Escreva aqui sua mensagem...\n\nCom carinho,\nEu ‚ù§Ô∏è",
      from: "Seu nome"
    },
    simples: {
      title: "Oi, vim deixar isso aqui‚Ä¶",
      to: "Voc√™",
      message: "Escreva aqui sua mensagem...",
      from: "‚Äî Seu nome"
    }
  };

  const assets = {
    amor: { photo: null }, // File + _dataUrl
    simples: {}
  };

  // =============================
  // UI
  // =============================
  function renderThemes(){
    const root = $("#themes");
    root.innerHTML = "";

    Object.entries(THEMES).forEach(([id, t])=>{
      const el = document.createElement("div");
      el.className = "theme" + (id === themeId ? " active" : "");
      el.innerHTML = `
        <div class="emoji">${t.emoji}</div>
        <div>
          <p class="name">${escHtml(t.name)}</p>
          <p class="desc">${escHtml(t.desc)}</p>
        </div>
      `;
      el.addEventListener("click", ()=>{
        themeId = id;
        $("#editor").style.display = "block";
        $("#pickTheme").style.display = "none";
        $("#btnExport").disabled = false;
        $("#btnPay").disabled = false;
        renderThemes();
        renderForm();
        updatePreview();
      });
      root.appendChild(el);
    });
  }

  function renderForm(){
    const t = THEMES[themeId];
    const data = state[themeId] || (state[themeId] = {});
    $("#themeHint").textContent = t.hint || "";

    const form = $("#form");
    form.innerHTML = "";

    t.fields.forEach(field=>{
      const el = makeField(field, data[field.key], async (field, inputEl)=>{
        if(field.type === "file"){
          const f = inputEl.files && inputEl.files[0] ? inputEl.files[0] : null;
          if(themeId === "amor" && field.key === "photo"){
            assets.amor.photo = f;
            if(assets.amor.photo){
              assets.amor.photo._dataUrl = await readFileAsDataURL(assets.amor.photo);
            }
          }
        } else {
          data[field.key] = inputEl.value;
        }
        updatePreview();
      });

      form.appendChild(el);
    });
  }

  function updatePreview(){
    if(!themeId){
      $("#preview").srcdoc = basePreviewEmpty();
      return;
    }
    const t = THEMES[themeId];
    const data = state[themeId] || {};
    const html = t.generate(data, assets[themeId], "preview");
    $("#preview").srcdoc = html;
  }

  // =============================
  // Export ZIP (offline)
  // =============================
  async function exportZip(){
    if(!themeId) return;

    const t = THEMES[themeId];
    const data = state[themeId] || {};
    const zip = new JSZip();

    const html = t.generate(data, assets[themeId], "export");
    zip.file("index.html", html);

    const imgFolder = zip.folder("imagens");

    if(themeId === "amor"){
      const photo = assets.amor.photo;
      if(photo){
        imgFolder.file(safeName(photo.name), photo);
      }
    }

    const blob = await zip.generateAsync({type:"blob"});
    saveAs(blob, `cartinha_${themeId}.zip`);
  }
  $("#btnExport").addEventListener("click", exportZip);

  // =============================
  // Pagamento + Link (Pix)
  // =============================
  async function checkPaidLoop(id){
    const maxTries = 40; // ~2min
    for(let i=0;i<maxTries;i++){
      await new Promise(r=>setTimeout(r, 3000));
      try{
        const res = await fetch("/api/status?id=" + encodeURIComponent(id), { cache:"no-store" });
        const { json } = await readResponseSmart(res);
        if(res.ok && json && json.paid && json.url){
          return json.url;
        }
      }catch(e){}
    }
    return null;
  }

  async function payAndGenerateLink(){
    if(!themeId) return;

    const t = THEMES[themeId];
    const data = state[themeId] || {};
    const html = t.generate(data, assets[themeId], "publish");

    const btn = $("#btnPay");
    const old = btn.textContent;
    btn.disabled = true;
    btn.textContent = "‚è≥ Criando pagamento...";

    try{
      const r = await fetch("/api/publish", {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ theme: themeId, html }),
        cache: "no-store"
      });

      const { text, json } = await readResponseSmart(r);

      if(!r.ok){
        // mostra tudo no modal
        const payload = json ? pretty(json) : text;
        throw new Error(`Falha (${r.status})\n\n${payload}`);
      }

      const j = json || {};
      const checkoutUrl = j.checkout_url;
      const id = j.id;

      if(!checkoutUrl || !id){
        throw new Error("Resposta OK, mas sem checkout_url/id.\n\n" + pretty(j));
      }

      openModal({
        title: "üí≥ Pague no Pix para liberar o link",
        hint: "Abra o pagamento, conclua no Pix e depois clique em ‚ÄúJ√° paguei‚Äù.",
        linkText: checkoutUrl,
        buttons: [
          { type:"a", label:"üîó Abrir pagamento", href: checkoutUrl },
          { label:"üìã Copiar link do pagamento", onClick: async ()=>{
              try{ await navigator.clipboard.writeText(checkoutUrl);}catch(e){}
              alert("Copiado ‚úÖ");
            }
          },
          { label:"‚úÖ J√° paguei ‚Äî verificar", onClick: async ()=>{
              openModal({
                title: "‚è≥ Verificando pagamento‚Ä¶",
                hint: "Se o Pix acabou de ser pago, pode levar alguns segundos para confirmar.",
                linkText: "",
                buttons: []
              });

              const finalUrl = await checkPaidLoop(id);
              if(finalUrl){
                openModal({
                  title: "‚úÖ Link gerado",
                  hint: "Copie e mande no WhatsApp/Instagram.",
                  linkText: finalUrl,
                  buttons: [
                    { label:"üìã Copiar", onClick: async ()=>{ try{ await navigator.clipboard.writeText(finalUrl);}catch(e){} alert("Copiado ‚úÖ"); } },
                    { type:"a", label:"üîó Abrir", href: finalUrl },
                    { type:"a", label:"üí¨ WhatsApp", href:"https://wa.me/?text="+encodeURIComponent(finalUrl) }
                  ]
                });
              } else {
                openModal({
                  title: "‚ö†Ô∏è Ainda n√£o confirmou",
                  hint: "Se voc√™ pagou agora, espere um pouco e tente verificar de novo.",
                  linkText: "",
                  buttons: [
                    { type:"a", label:"üîó Abrir pagamento", href: checkoutUrl },
                    { label:"‚úÖ Verificar de novo", onClick: async ()=>{
                        openModal({ title:"‚è≥ Verificando‚Ä¶", hint:"Aguarde alguns segundos.", linkText:"", buttons: [] });
                        const again = await checkPaidLoop(id);
                        if(again){
                          openModal({
                            title:"‚úÖ Link gerado",
                            hint:"Tudo certo!",
                            linkText: again,
                            buttons:[
                              { label:"üìã Copiar", onClick: async ()=>{ try{ await navigator.clipboard.writeText(again);}catch(e){} alert("Copiado ‚úÖ"); } },
                              { type:"a", label:"üîó Abrir", href:again }
                            ]
                          });
                        } else {
                          openModal({
                            title:"‚ö†Ô∏è Sem confirma√ß√£o ainda",
                            hint:"Se continuar, provavelmente o webhook n√£o est√° chegando. Confira URL do webhook e logs.",
                            linkText:"",
                            buttons:[ { type:"a", label:"üîó Abrir pagamento", href: checkoutUrl } ]
                          });
                        }
                      }
                    }
                  ]
                });
              }
            }
          }
        ]
      });

    }catch(e){
      openModal({
        title: "‚ùå Erro",
        hint: "O servidor respondeu com erro. Copie o detalhe abaixo e me mande.",
        linkText: String(e?.message || e),
        buttons: [
          { label:"üìã Copiar detalhe", onClick: async ()=>{
              try{ await navigator.clipboard.writeText(String(e?.message || e)); }catch(err){}
              alert("Copiado ‚úÖ");
            }
          }
        ]
      });
    }finally{
      btn.disabled = false;
      btn.textContent = old;
    }
  }

  $("#btnPay").addEventListener("click", payAndGenerateLink);
  $("#btnPay").textContent = "üí≥ Pagar " + PRICE_LABEL + " e gerar link";

  // =============================
  // Diagn√≥stico r√°pido
  // =============================
  async function diagPublish(){
    // tenta chamar /api/publish com um HTML m√≠nimo
    const html = `<!doctype html><html><head><meta charset="utf-8"><title>Teste</title></head><body>ok</body></html>`;
    openModal({ title:"üß™ Diagn√≥stico", hint:"Chamando /api/publish com HTML m√≠nimo‚Ä¶", linkText:"", buttons:[] });

    try{
      const r = await fetch("/api/publish", {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ theme:"amor", html }),
        cache:"no-store"
      });

      const { text, json } = await readResponseSmart(r);
      const payload = json ? pretty(json) : text;

      openModal({
        title: r.ok ? "‚úÖ /api/publish OK" : `‚ùå /api/publish Falhou (${r.status})`,
        hint: "Aqui est√° a resposta completa do servidor:",
        linkText: payload || "(vazio)",
        buttons: [
          { label:"üìã Copiar", onClick: async ()=>{ try{ await navigator.clipboard.writeText(payload || ""); }catch(e){} alert("Copiado ‚úÖ"); } }
        ]
      });
    }catch(e){
      openModal({
        title:"‚ùå Diagn√≥stico falhou",
        hint:"Erro no fetch:",
        linkText: String(e?.message || e),
        buttons:[]
      });
    }
  }
  $("#btnDiag").addEventListener("click", diagPublish);

  // =============================
  // Templates
  // =============================
  function baseDoc(title, body){
    return `<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>${escHtml(title)}</title>
<style>
  :root{
    --bg1:#0b1020; --bg2:#111a33;
    --text: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.68);
    --stroke: rgba(255,255,255,.16);
    --shadow: 0 18px 50px rgba(0,0,0,.45);
    --r: 22px;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1100px 800px at 25% 20%, #24346b 0%, transparent 60%),
      radial-gradient(1000px 750px at 80% 25%, #6b235e 0%, transparent 55%),
      linear-gradient(135deg, var(--bg1), var(--bg2));
    min-height:100vh;
    padding: 18px 0;
  }
  .card{
    width:min(920px, calc(100% - 32px));
    margin: 0 auto;
    border-radius: var(--r);
    background: rgba(20,20,30,.58);
    border:1px solid var(--stroke);
    box-shadow: var(--shadow);
    backdrop-filter: blur(14px);
    overflow:hidden;
  }
  .h{padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.10);}
  .b{padding:18px;}
  .muted{color:var(--muted); font-size:12px; line-height:1.45}
  .h1{margin:0; font-size:20px;}
</style>
</head>
<body>
${body}
</body>
</html>`;
  }

  function genCartinhaGlass(data, a, mode){
    const title = data.title || "Uma cartinha pra voc√™ ‚ù§Ô∏è";
    const to = data.to || "";
    const msg = data.message || "";
    const from = data.from || "";

    const photo = a.photo;
    const photoSrc = photo
      ? (
          mode === "export"
            ? `./imagens/${safeName(photo.name)}`
            : (photo._dataUrl || "")
        )
      : "";

    return baseDoc(title, `
      <div class="card">
        <div class="h">
          <div class="h1">${escHtml(title)}</div>
          ${to ? `<div class="muted" style="margin-top:6px;">Para: <b>${escHtml(to)}</b></div>` : ""}
        </div>
        <div class="b">
          ${photoSrc ? `
            <div style="margin-bottom:12px; border-radius:18px; overflow:hidden; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18);">
              <img src="${escAttr(photoSrc)}" alt="" style="width:100%; display:block;">
            </div>
          ` : ""}

          <div style="padding:16px; border-radius:18px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18);">
            <div style="white-space:pre-wrap; line-height:1.75;">${escHtml(msg)}</div>
          </div>

          ${from ? `
            <div style="margin-top:14px; text-align:right; color:rgba(255,255,255,.82);">
              ‚Äî ${escHtml(from)}
            </div>
          ` : ""}
        </div>
      </div>
    `);
  }

  function genCartinhaSimples(data){
    const title = data.title || "Oi, vim deixar isso aqui‚Ä¶";
    const to = data.to || "";
    const msg = data.message || "";
    const from = data.from || "";

    return baseDoc(title, `
      <div class="card">
        <div class="h">
          <div class="h1">${escHtml(title)}</div>
          ${to ? `<div class="muted" style="margin-top:6px;">Para: <b>${escHtml(to)}</b></div>` : ""}
        </div>
        <div class="b">
          <div style="padding:16px; border-radius:18px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18);">
            <div style="white-space:pre-wrap; line-height:1.75;">${escHtml(msg)}</div>
          </div>

          ${from ? `
            <div style="margin-top:14px; text-align:right; color:rgba(255,255,255,.82);">
              ${escHtml(from)}
            </div>
          ` : ""}
        </div>
      </div>
    `);
  }

  function basePreviewEmpty(){
    return baseDoc("Preview", `
      <div class="card">
        <div class="h"><div class="h1">üëà Escolha um tema</div></div>
        <div class="b">
          <div class="muted">Selecione um tema na esquerda pra come√ßar a escrever.</div>
        </div>
      </div>
    `);
  }

  // =============================
  // init
  // =============================
  renderThemes();
  updatePreview();
</script>
</body>
</html>

