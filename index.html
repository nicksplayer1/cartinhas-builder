<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Construtor de Cartinhas</title>

  <style>
    :root{
      --bg:#0b1020;
      --panel: rgba(20,20,30,.55);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --r: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1100px 800px at 25% 20%, #24346b 0%, transparent 60%),
        radial-gradient(1000px 750px at 80% 25%, #6b235e 0%, transparent 55%),
        linear-gradient(135deg, #0b1020, #111a33);
      min-height:100vh;
    }
    header{
      padding:18px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; flex-direction:column; gap:4px;}
    .brand h1{margin:0; font-size:16px;}
    .brand p{margin:0; font-size:12px; color:var(--muted)}
    .bar{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center;}

    .wrap{
      padding: 0 18px 18px;
      display:grid;
      grid-template-columns: 390px 1fr;
      gap:14px;
    }
    .card{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .card-h{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .card-h .t{font-size:13px; color:var(--text); opacity:.95}
    .card-b{padding:12px}

    .themes{display:grid; grid-template-columns: 1fr; gap:10px;}
    .theme{
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      display:flex; gap:10px; align-items:flex-start;
      transition: .15s ease;
    }
    .theme:hover{ background: rgba(0,0,0,.26); }
    .theme.active{
      border-color: rgba(255,255,255,.25);
      background: rgba(255,255,255,.08);
    }
    .emoji{font-size:22px; width:32px; text-align:center}
    .theme .name{font-size:13px; margin:0}
    .theme .desc{font-size:12px; color:var(--muted); margin:4px 0 0}

    label{font-size:12px; color:var(--muted)}
    input, textarea{
      width:100%;
      margin-top:6px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding:10px 12px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height: 110px; resize:vertical;}
    .grid{display:grid; gap:10px;}
    .btn{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding:10px 12px;
      cursor:pointer;
      font-size:13px;
      display:inline-flex; gap:8px; align-items:center;
      text-decoration:none;
    }
    .btn:hover{ background: rgba(255,255,255,.14); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .hint{font-size:12px; color:var(--muted); line-height:1.45}
    .sep{height:1px; background: rgba(255,255,255,.10); margin:12px 0;}

    .preview{
      height: calc(100vh - 100px);
      width:100%;
      border:0;
      border-radius: 16px;
      background: rgba(0,0,0,.15);
    }

    .empty{
      padding:16px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.18);
      color:rgba(255,255,255,.75);
      background: rgba(0,0,0,.12);
    }

    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      place-items:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(740px, 100%);
      border-radius: 18px;
      background: rgba(20,20,30,.82);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .modalH{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .modalB{padding:14px;}
    .rowBtns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .linkBox{
      width:100%;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      font-size:13px;
      word-break: break-all;
      white-space: pre-wrap;
    }

    .mini{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
    }
    .mini a{ color:#9bd1ff; text-decoration:none; word-break:break-all }
    .mini a:hover{ text-decoration:underline }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color: rgba(255,255,255,.80);
    }

    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr; }
      .preview{height: 70vh;}
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <h1>üíå Construtor de Cartinhas</h1>
      <p>Escolha um tema, escreva. Pague e gere um link. Se perder, recupere neste mesmo aparelho (hist√≥rico local).</p>
      <div class="hint" style="margin-top:4px;">
        ‚ö†Ô∏è O hist√≥rico local funciona s√≥ neste navegador/aparelho. Se limpar os dados do navegador, ele pode sumir.
      </div>
    </div>

    <div class="bar">
      <span class="pill" id="localCountPill" title="Quantidade de links salvos neste aparelho">üïò 0 salvos</span>
      <button class="btn" id="btnMyLinks">üïò Meus links</button>
      <button class="btn" id="btnPay" disabled>üí≥ Pagar R$ 4,90 e gerar link</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="card-h">
        <div class="t">üé≠ Temas</div>
        <div class="hint">Toque em um tema pra abrir e editar.</div>
      </div>
      <div class="card-b">
        <div class="themes" id="themes"></div>

        <div class="sep"></div>

        <div id="editor" style="display:none;">
          <div class="hint" id="themeHint" style="margin-bottom:10px;"></div>
          <div class="grid" id="form"></div>

          <div class="hint" style="margin-top:10px;">
            No celular: escolha a foto/v√≠deo e aguarde carregar. Se n√£o aparecer no preview, troque e tente de novo.
          </div>

          <div class="mini" id="localHistoryBox" style="display:none;">
            <div class="hint" style="margin:0 0 6px;">üìå √öltimo link salvo neste aparelho:</div>
            <div><a id="localLastLink" href="#" target="_blank" rel="noopener"></a></div>
            <div class="hint" style="margin-top:6px;" id="localLastMeta"></div>
          </div>
        </div>

        <div id="pickTheme" class="empty">
          üëÜ Escolha um tema acima pra come√ßar.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-h">
        <div class="t">üëÄ Preview</div>
        <div class="hint">Atualiza automaticamente</div>
      </div>
      <div class="card-b">
        <iframe
          class="preview"
          id="preview"
          sandbox="allow-same-origin allow-scripts"
          allow="autoplay; fullscreen"
          allowfullscreen
        ></iframe>
      </div>
    </div>
  </div>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalH">
        <div style="font-size:13px;" id="modalTitle">‚úÖ</div>
        <button class="btn" id="btnCloseModal">‚úñÔ∏è Fechar</button>
      </div>
      <div class="modalB">
        <div class="hint" id="modalHint"></div>
        <div class="linkBox" id="modalLink" style="margin-top:10px; display:none;"></div>
        <div class="rowBtns" id="modalBtns"></div>
      </div>
    </div>
  </div>

<script>
  const PRICE_LABEL = "R$ 4,90";
  const $ = (s) => document.querySelector(s);

  // =========================
  // LocalStorage (hist√≥rico local)
  // =========================
  const STORAGE_KEY = "cartinhas_local_v1";
  const LAST_KEY  = "cartinhas:last";

  function loadLocalCartinhas(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      return [];
    }
  }
  function saveLocalCartinhas(arr){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr.slice(0, 50)));
    }catch(e){}
  }
  function upsertLocalCartinha(item){
    const arr = loadLocalCartinhas();
    const idx = arr.findIndex(x => x.id === item.id);
    if(idx >= 0){
      arr[idx] = { ...arr[idx], ...item };
    }else{
      arr.unshift(item);
    }
    arr.sort((a,b)=> (new Date(b.createdAt||0)) - (new Date(a.createdAt||0)));
    saveLocalCartinhas(arr);
    updateLocalPill();
  }
  function removeLocalCartinha(id){
    const arr = loadLocalCartinhas().filter(x => x.id !== id);
    saveLocalCartinhas(arr);
    updateLocalPill();
  }
  function updateLocalPill(){
    const n = loadLocalCartinhas().length;
    const pill = $("#localCountPill");
    if(pill) pill.textContent = `üïò ${n} salvos`;
  }

  function saveLastLink(entry){
    const base = { at: Date.now(), ...(entry || {}) };
    if(!base.ts) base.ts = base.at;
    try{ localStorage.setItem(LAST_KEY, JSON.stringify(base)); }catch(e){}
    renderLocalHistory();
  }
  function loadLastLink(){
    try{
      const raw = localStorage.getItem(LAST_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(obj && !obj.at && obj.ts) obj.at = obj.ts;
      if(obj && !obj.ts && obj.at) obj.ts = obj.at;
      return obj;
    }catch(e){ return null; }
  }
  function renderLocalHistory(){
    const box = $("#localHistoryBox");
    if(!box) return;
    const last = loadLastLink();
    if(!last || !last.url){
      box.style.display = "none";
      return;
    }
    box.style.display = "block";
    $("#localLastLink").href = last.url;
    $("#localLastLink").textContent = last.url;
    $("#localLastMeta").textContent =
      `Tema: ${last.theme || "-"} ‚Ä¢ ${new Date(last.at || last.ts || Date.now()).toLocaleString("pt-BR")}`;
  }

  function formatDateBR(iso){
    try{ return new Date(iso).toLocaleString("pt-BR"); }
    catch(e){ return iso || ""; }
  }

  function escHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (m)=>( {
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m] ));
  }
  function escAttr(s){
    return String(s ?? "").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }
  function readFileAsDataURL(file){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = () => resolve(String(r.result));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  // =========================
  // Upload de v√≠deo para Vercel Blob (via /api/upload)
  // =========================
  let _blobClientPromise = null;

  async function getBlobClient(){
    if(!_blobClientPromise){
      _blobClientPromise = import("https://esm.sh/@vercel/blob/client");
    }
    return _blobClientPromise;
  }

  async function uploadVideoToBlob(file, onProgress){
    const mod = await getBlobClient();
    const upload = mod.upload;

    const ext = (String(file.name || "").split(".").pop() || "mp4").toLowerCase();
    const path = `cartinhas/videos/${Date.now()}_${Math.random().toString(16).slice(2)}.${ext}`;

    const blob = await upload(path, file, {
      access: "public",
      handleUploadUrl: "/api/upload",
      contentType: file.type || undefined,
      onUploadProgress: (ev) => {
        if(!onProgress) return;
        if(typeof ev?.percentage === "number") onProgress(ev.percentage);
      }
    });

    if(!blob || !blob.url) throw new Error("Upload n√£o retornou URL.");
    return blob.url;
  }

  function makeField(field, value, onChange){
    const wrap = document.createElement("div");
    const id = "f_" + field.key;

    wrap.innerHTML = `<label for="${id}">${escHtml(field.label)}</label>`;

    let el;
    if(field.type === "textarea"){
      el = document.createElement("textarea");
      el.id = id;
      el.value = value ?? "";
      if(field.placeholder) el.placeholder = field.placeholder;
    } else if(field.type === "file"){
      el = document.createElement("input");
      el.id = id;
      el.type = "file";
      el.accept = field.accept || "";
    } else {
      el = document.createElement("input");
      el.id = id;
      el.type = field.inputType || "text";   // ‚úÖ suporta date/time/etc
      el.value = value ?? "";
      if(field.placeholder) el.placeholder = field.placeholder;
    }

    el.addEventListener("input", () => onChange(field, el));
    el.addEventListener("change", () => onChange(field, el));
    wrap.appendChild(el);

    if(field.help || field.type === "file"){
      const h = document.createElement("div");
      h.className = "hint";
      h.style.marginTop = "6px";
      h.id = "help_" + field.key;
      h.textContent = field.help || "";
      wrap.appendChild(h);
    }

    return wrap;
  }

  function setHelp(key, text){
    const el = document.getElementById("help_" + key);
    if(el) el.textContent = text || "";
  }

  function openModal({ title, hint, linkText, buttons }){
    $("#modalTitle").textContent = title || "‚úÖ";
    $("#modalHint").textContent = hint || "";
    const linkBox = $("#modalLink");
    const btns = $("#modalBtns");

    btns.innerHTML = "";

    if(linkText){
      linkBox.style.display = "block";
      linkBox.textContent = linkText;
    } else {
      linkBox.style.display = "none";
      linkBox.textContent = "";
    }

    (buttons || []).forEach(b=>{
      if(b.type === "a"){
        const a = document.createElement("a");
        a.className = "btn";
        a.textContent = b.label;
        a.href = b.href || "#";
        a.target = b.target || "_blank";
        a.rel = "noopener";
        btns.appendChild(a);
      } else {
        const bt = document.createElement("button");
        bt.className = "btn";
        bt.textContent = b.label;
        bt.onclick = b.onClick;
        btns.appendChild(bt);
      }
    });

    $("#modalBack").style.display = "grid";
  }
  function closeModal(){ $("#modalBack").style.display = "none"; }

  $("#btnCloseModal").addEventListener("click", closeModal);
  $("#modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") closeModal(); });

  function makeMyLinksHtml(){
    const items = loadLocalCartinhas();
    if(!items.length){
      return `<div class="hint">Nenhum link salvo neste aparelho ainda.</div>`;
    }

    return `
      <div class="hint" style="margin-bottom:10px;">
        Estes links ficam salvos <b>somente neste aparelho/navegador</b>.
      </div>
      <div style="display:grid; gap:10px;">
        ${items.map(it=>{
          const status = it.finalUrl ? "‚úÖ aprovado" : "‚è≥ pendente";
          const primary = it.finalUrl || it.checkoutUrl || "";
          const title = it.title || `Cartinha (${it.theme||"tema"})`;
          return `
            <div style="border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.18); border-radius:16px; padding:12px;">
              <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
                <div style="min-width:0;">
                  <div style="font-size:13px; font-weight:600;">${escHtml(title)}</div>
                  <div class="hint" style="margin-top:4px;">
                    ${status} ‚Ä¢ ${escHtml(formatDateBR(it.createdAt))}
                  </div>
                  <div class="hint" style="margin-top:6px; word-break:break-all;">
                    ${escHtml(primary)}
                  </div>
                </div>
                <button class="btn" data-del="${escAttr(it.id)}" title="Remover do hist√≥rico">üóëÔ∏è</button>
              </div>

              <div class="rowBtns" style="margin-top:10px;">
                ${primary ? `<a class="btn" href="${escAttr(primary)}" target="_blank" rel="noopener">üîó Abrir</a>` : ""}
                ${primary ? `<button class="btn" data-copy="${escAttr(primary)}">üìã Copiar</button>` : ""}
                ${!it.finalUrl ? `<button class="btn" data-check="${escAttr(it.id)}">üîÑ Verificar pagamento</button>` : ""}
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  async function checkAndUpdateOne(id){
    const res = await fetch("/api/status?id=" + encodeURIComponent(id));
    const j = await res.json().catch(()=> ({}));
    if(res.ok && j && j.url){
      upsertLocalCartinha({ id, finalUrl: j.url, status: "approved" });
      saveLastLink({ id, url: j.url, at: Date.now(), stage:"paid" });
      return j.url;
    }
    return null;
  }

  function openMyLinksModal(){
    openModal({ title: "üïò Links salvos neste aparelho", hint: "", linkText: "", buttons: [] });

    const hintEl = $("#modalHint");
    hintEl.innerHTML = makeMyLinksHtml();

    hintEl.querySelectorAll("[data-copy]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const v = btn.getAttribute("data-copy");
        try{ await navigator.clipboard.writeText(v); }catch(e){}
        alert("Copiado ‚úÖ");
      });
    });

    hintEl.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-del");
        removeLocalCartinha(id);
        hintEl.innerHTML = makeMyLinksHtml();
      });
    });

    hintEl.querySelectorAll("[data-check]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-check");
        btn.disabled = true;
        btn.textContent = "‚è≥ verificando...";
        try{
          const url = await checkAndUpdateOne(id);
          alert(url ? "Aprovado ‚úÖ Link atualizado!" : "Ainda pendente. Tente novamente em alguns segundos.");
        }catch(e){
          alert("Erro ao verificar.");
        }finally{
          btn.disabled = false;
          btn.textContent = "üîÑ Verificar pagamento";
          hintEl.innerHTML = makeMyLinksHtml();
        }
      });
    });
  }

  $("#btnMyLinks").addEventListener("click", openMyLinksModal);

  // =========================
  // THEMES (inclui Presente + V√≠deo Glass + Convite VIP)
  // =========================
  const THEMES = {
    amor: {
      emoji: "üíå",
      name: "Cartinha de Amor",
      desc: "Carta glass + foto opcional.",
      hint: "Ideal pra mandar por link (ap√≥s pagamento Pix).",
      fields: [
        { key:"title", label:"T√≠tulo", placeholder:"Uma cartinha pra voc√™ ‚ù§Ô∏è" },
        { key:"to", label:"Para", placeholder:"Meu amor" },
        { key:"message", label:"Mensagem", type:"textarea", placeholder:"Escreva aqui sua mensagem..." },
        { key:"from", label:"Assinatura", placeholder:"Seu nome" },
        { key:"photo", label:"Foto (opcional)", type:"file", accept:"image/*", help:"Aparece no topo da cartinha." }
      ],
      generate: (data, asset) => genCartinhaGlass(data, asset)
    },

    simples: {
      emoji: "‚úâÔ∏è",
      name: "Cartinha Simples",
      desc: "Sem foto, s√≥ texto (bem direto).",
      hint: "Perfeita pra algo r√°pido.",
      fields: [
        { key:"title", label:"T√≠tulo", placeholder:"Oi, vim deixar isso aqui..." },
        { key:"to", label:"Para", placeholder:"Fulano/Fulana" },
        { key:"message", label:"Mensagem", type:"textarea", placeholder:"Escreva aqui..." },
        { key:"from", label:"Assinatura", placeholder:"Seu nome" }
      ],
      generate: (data) => genCartinhaSimples(data)
    },

    presenteVideo: {
      emoji: "üéÅ",
      name: "Presente + V√≠deo (Glass)",
      desc: "Presente no centro ‚Üí abre e toca v√≠deo com √°udio.",
      hint: "Escolha um v√≠deo (at√© 25MB). Ele ser√° enviado pro Blob e ficar√° p√∫blico.",
      fields: [
        { key:"title", label:"T√≠tulo", placeholder:"Hoje √© dia de comemorar! üéâ" },
        { key:"caption", label:"Legenda (opcional)", placeholder:"Toque no presente pra abrir a surpresa" },
        { key:"video", label:"V√≠deo (at√© 25MB)", type:"file", accept:"video/*", help:"Selecione um v√≠deo para enviar." }
      ],
      generate: (data, asset) => genPresenteVideoGlass(data, asset)
    },

    // ‚úÖ NOVO: Convite VIP
    vipConvite: {
      emoji: "ü•Ç",
      name: "Convite VIP",
      desc: "Ingresso VIP premium + confirma√ß√£o + trailer opcional.",
      hint: "Preencha os dados. Trailer (v√≠deo) √© opcional (at√© 25MB).",
      fields: [
        { key:"event", label:"Nome do evento", placeholder:"Convite VIP ‚Äî Evento Exclusivo" },
        { key:"guest", label:"Nome do convidado (opcional)", placeholder:"Ex: Nicollas" },
        { key:"date", label:"Data", inputType:"date", placeholder:"" },
        { key:"time", label:"Hora", inputType:"time", placeholder:"" },
        { key:"place", label:"Local", placeholder:"Ex: Sal√£o Imperial" },
        { key:"address", label:"Endere√ßo (pra Maps)", placeholder:"Av. Paulista, 1000 - S√£o Paulo" },
        { key:"dress", label:"Dress code (opcional)", placeholder:"Ex: Traje preto (all black)" },
        { key:"message", label:"Mensagem (opcional)", type:"textarea", placeholder:"Escreva uma mensagem curta pro convidado‚Ä¶" },
        { key:"video", label:"V√≠deo (trailer opcional ‚Äî at√© 25MB)", type:"file", accept:"video/*", help:"Opcional. Se enviar, aparece o bot√£o ‚ÄúAssistir Trailer (VIP)‚Äù." }
      ],
      generate: (data, asset) => genConviteVIP(data, asset)
    }
  };

  let themeId = null;

  const state = {
    amor: {
      title: "Uma cartinha pra voc√™ ‚ù§Ô∏è",
      to: "Meu amor",
      message: "Escreva aqui sua mensagem...\n\nCom carinho,\nEu ‚ù§Ô∏è",
      from: "Seu nome"
    },
    simples: {
      title: "Oi, vim deixar isso aqui‚Ä¶",
      to: "Voc√™",
      message: "Escreva aqui sua mensagem...",
      from: "‚Äî Seu nome"
    },
    presenteVideo: {
      title: "Hoje √© dia de comemorar! üéâ",
      caption: "Toque no presente pra abrir a surpresa"
    },
    vipConvite: {
      event: "Convite VIP ‚Äî Evento Exclusivo",
      guest: "",
      date: "",
      time: "",
      place: "Local VIP",
      address: "",
      dress: "",
      message: "Voc√™ est√° na lista VIP. Confirme presen√ßa e prepare-se para uma noite especial. ‚ú®"
    }
  };

  const assets = {
    amor: { photo: null },
    simples: {},
    presenteVideo: { videoFile: null, videoUrl: "" },
    vipConvite: { videoFile: null, videoUrl: "" }
  };

  function refreshPayButtonState(){
    const pay = $("#btnPay");
    if(!themeId){
      pay.disabled = true;
      return;
    }
    if(themeId === "presenteVideo"){
      pay.disabled = !assets.presenteVideo.videoUrl;
      return;
    }
    // vipConvite: v√≠deo √© opcional
    pay.disabled = false;
  }

  function renderThemes(){
    const root = $("#themes");
    root.innerHTML = "";

    Object.entries(THEMES).forEach(([id, t])=>{
      const el = document.createElement("div");
      el.className = "theme" + (id === themeId ? " active" : "");
      el.innerHTML = `
        <div class="emoji">${t.emoji}</div>
        <div>
          <p class="name">${escHtml(t.name)}</p>
          <p class="desc">${escHtml(t.desc)}</p>
        </div>
      `;
      el.addEventListener("click", ()=>{
        themeId = id;
        $("#editor").style.display = "block";
        $("#pickTheme").style.display = "none";

        renderThemes();
        renderForm();
        updatePreview();
        renderLocalHistory();
        refreshPayButtonState();
      });
      root.appendChild(el);
    });
  }

  function renderForm(){
    const t = THEMES[themeId];
    const data = state[themeId] || (state[themeId] = {});
    $("#themeHint").textContent = t.hint || "";

    const form = $("#form");
    form.innerHTML = "";

    t.fields.forEach(field=>{
      const el = makeField(field, data[field.key], async (field, inputEl)=>{
        if(field.type === "file"){
          const f = inputEl.files && inputEl.files[0] ? inputEl.files[0] : null;

          // FOTO (tema amor)
          if(themeId === "amor" && field.key === "photo"){
            assets.amor.photo = f;
            if(assets.amor.photo){
              assets.amor.photo._dataUrl = await readFileAsDataURL(assets.amor.photo);
            }
            updatePreview();
            refreshPayButtonState();
            return;
          }

          // V√çDEO (tema presenteVideo) -> obrigat√≥rio
          if(themeId === "presenteVideo" && field.key === "video"){
            if(!f){
              assets.presenteVideo.videoFile = null;
              assets.presenteVideo.videoUrl = "";
              setHelp("video", "Selecione um v√≠deo para enviar.");
              updatePreview();
              refreshPayButtonState();
              return;
            }

            const MAX = 25 * 1024 * 1024;
            if(f.size > MAX){
              assets.presenteVideo.videoFile = null;
              assets.presenteVideo.videoUrl = "";
              inputEl.value = "";
              setHelp("video", "‚ùå V√≠deo muito grande. Limite: 25MB.");
              alert("V√≠deo muito grande. Limite: 25MB.");
              updatePreview();
              refreshPayButtonState();
              return;
            }

            setHelp("video", "‚è≥ Enviando v√≠deo‚Ä¶ 0%");
            try{
              const url = await uploadVideoToBlob(f, (pct)=> setHelp("video", `‚è≥ Enviando v√≠deo‚Ä¶ ${Math.round(pct)}%`));
              assets.presenteVideo.videoFile = f;
              assets.presenteVideo.videoUrl = url;
              setHelp("video", "‚úÖ V√≠deo enviado! (pronto pra gerar o link)");
            }catch(err){
              console.error("Falha no upload do v√≠deo:", err);
              assets.presenteVideo.videoFile = null;
              assets.presenteVideo.videoUrl = "";
              inputEl.value = "";
              setHelp("video", "‚ùå Falha no upload. Veja o console (F12) para detalhes.");
              alert("Falha no upload do v√≠deo. Veja o console (F12) para detalhes.");
            }

            updatePreview();
            refreshPayButtonState();
            return;
          }

          // V√çDEO opcional (tema vipConvite)
          if(themeId === "vipConvite" && field.key === "video"){
            if(!f){
              assets.vipConvite.videoFile = null;
              assets.vipConvite.videoUrl = "";
              setHelp("video", "Opcional. Se enviar, aparece o bot√£o ‚ÄúAssistir Trailer (VIP)‚Äù.");
              updatePreview();
              refreshPayButtonState();
              return;
            }

            const MAX = 25 * 1024 * 1024;
            if(f.size > MAX){
              assets.vipConvite.videoFile = null;
              assets.vipConvite.videoUrl = "";
              inputEl.value = "";
              setHelp("video", "‚ùå V√≠deo muito grande. Limite: 25MB.");
              alert("V√≠deo muito grande. Limite: 25MB.");
              updatePreview();
              refreshPayButtonState();
              return;
            }

            setHelp("video", "‚è≥ Enviando v√≠deo‚Ä¶ 0%");
            try{
              const url = await uploadVideoToBlob(f, (pct)=> setHelp("video", `‚è≥ Enviando v√≠deo‚Ä¶ ${Math.round(pct)}%`));
              assets.vipConvite.videoFile = f;
              assets.vipConvite.videoUrl = url;
              setHelp("video", "‚úÖ Trailer enviado! (o bot√£o VIP vai aparecer)");
            }catch(err){
              console.error("Falha no upload do v√≠deo:", err);
              assets.vipConvite.videoFile = null;
              assets.vipConvite.videoUrl = "";
              inputEl.value = "";
              setHelp("video", "‚ùå Falha no upload. Veja o console (F12) para detalhes.");
              alert("Falha no upload do v√≠deo. Veja o console (F12) para detalhes.");
            }

            updatePreview();
            refreshPayButtonState();
            return;
          }

          updatePreview();
          refreshPayButtonState();
          return;
        }

        // Campos de texto
        data[field.key] = inputEl.value;
        updatePreview();
        refreshPayButtonState();
      });

      form.appendChild(el);
    });

    if(themeId === "presenteVideo"){
      setHelp("video", assets.presenteVideo.videoUrl
        ? "‚úÖ V√≠deo j√° enviado (nesta sess√£o)."
        : "Selecione um v√≠deo para enviar."
      );
    }

    if(themeId === "vipConvite"){
      setHelp("video", assets.vipConvite.videoUrl
        ? "‚úÖ Trailer j√° enviado (nesta sess√£o)."
        : "Opcional. Se enviar, aparece o bot√£o ‚ÄúAssistir Trailer (VIP)‚Äù."
      );
    }
  }

  function updatePreview(){
    if(!themeId){
      $("#preview").srcdoc = basePreviewEmpty();
      return;
    }
    const t = THEMES[themeId];
    const data = state[themeId] || {};
    const html = t.generate(data, assets[themeId], "preview");
    $("#preview").srcdoc = html;
  }

  async function checkPaidLoop(id){
    const maxTries = 40;
    for(let i=0;i<maxTries;i++){
      await new Promise(r=>setTimeout(r, 3000));
      try{
        const res = await fetch("/api/status?id=" + encodeURIComponent(id));
        const j = await res.json().catch(()=> ({}));
        if(res.ok && j.paid && j.url) return j.url;
      }catch(e){}
    }
    return null;
  }

  async function readErrorBody(resp){
    const ct = resp.headers.get("content-type") || "";
    if(ct.includes("application/json")){
      const j = await resp.json().catch(()=> ({}));
      return JSON.stringify(j, null, 2);
    }
    const t = await resp.text().catch(()=> "");
    return t || `HTTP ${resp.status}`;
  }

  async function payAndGenerateLink(){
    if(!themeId) return;

    if(themeId === "presenteVideo" && !assets.presenteVideo.videoUrl){
      alert("Selecione e envie um v√≠deo (at√© 25MB) antes de gerar o link.");
      return;
    }

    const t = THEMES[themeId];
    const data = state[themeId] || {};
    const html = t.generate(data, assets[themeId], "publish");

    const btn = $("#btnPay");
    btn.disabled = true;
    btn.textContent = "‚è≥ Criando pagamento...";

    try{
      const r = await fetch("/api/publish", {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ theme: themeId, html })
      });

      if(!r.ok){
        const details = await readErrorBody(r);
        openModal({
          title: "‚ùå Erro no servidor (publish)",
          hint: "Detalhes abaixo (resposta da API):",
          linkText: details,
          buttons: []
        });
        return;
      }

      const j = await r.json().catch(()=> ({}));
      const checkoutUrl = j.checkout_url;
      const id = j.id;

      if(!checkoutUrl || !id){
        openModal({
          title: "‚ùå Resposta inesperada",
          hint: "A API respondeu OK, mas n√£o veio checkout_url/id.",
          linkText: JSON.stringify(j, null, 2),
          buttons: []
        });
        return;
      }

      upsertLocalCartinha({
        id,
        createdAt: new Date().toISOString(),
        theme: themeId,
        status: "pending",
        checkoutUrl,
        finalUrl: null,
        title: (state[themeId]?.title || state[themeId]?.event || `Cartinha (${themeId})`)
      });

      openModal({
        title: "üí≥ Pague no Pix para liberar o link",
        hint: "Abra o pagamento, conclua no Pix e depois clique em ‚ÄúJ√° paguei‚Äù. (O pedido ficou salvo no hist√≥rico local.)",
        linkText: checkoutUrl,
        buttons: [
          { type:"a", label:"üîó Abrir pagamento", href: checkoutUrl },
          { label:"üìã Copiar link do pagamento", onClick: async ()=>{
              try{ await navigator.clipboard.writeText(checkoutUrl);}catch(e){}
              alert("Copiado ‚úÖ");
            }
          },
          { label:"üïò Ver meus links", onClick: openMyLinksModal },
          { label:"‚úÖ J√° paguei ‚Äî verificar", onClick: async ()=>{
              openModal({ title:"‚è≥ Verificando pagamento‚Ä¶", hint:"Pode levar alguns segundos.", linkText:"", buttons: [] });
              const finalUrl = await checkPaidLoop(id);
              if(finalUrl){
                upsertLocalCartinha({ id, status:"approved", finalUrl });
                saveLastLink({ id, url: finalUrl, at: Date.now(), stage:"paid", theme: themeId });

                openModal({
                  title: "‚úÖ Link gerado",
                  hint: "Copie e mande no WhatsApp/Instagram. Ele tamb√©m ficou salvo no hist√≥rico local deste aparelho.",
                  linkText: finalUrl,
                  buttons: [
                    { label:"üìã Copiar", onClick: async ()=>{ try{ await navigator.clipboard.writeText(finalUrl);}catch(e){} alert("Copiado ‚úÖ"); } },
                    { type:"a", label:"üîó Abrir", href:finalUrl },
                    { type:"a", label:"üí¨ WhatsApp", href:"https://wa.me/?text="+encodeURIComponent(finalUrl) },
                    { label:"üïò Meus links", onClick: openMyLinksModal }
                  ]
                });

                renderLocalHistory();
              } else {
                openModal({
                  title: "‚ö†Ô∏è Ainda n√£o confirmou",
                  hint: "Se pagou agora, espere um pouco e tente novamente. Voc√™ tamb√©m pode ver em ‚ÄúMeus links‚Äù.",
                  linkText: "",
                  buttons: [
                    { type:"a", label:"üîó Abrir pagamento", href: checkoutUrl },
                    { label:"üïò Meus links", onClick: openMyLinksModal }
                  ]
                });
              }
            }
          }
        ]
      });

    }catch(e){
      openModal({
        title: "‚ùå Erro",
        hint: "Falha inesperada no navegador:",
        linkText: String(e?.message || e),
        buttons: []
      });
    }finally{
      btn.textContent = "üí≥ Pagar " + PRICE_LABEL + " e gerar link";
      refreshPayButtonState();
    }
  }

  $("#btnPay").addEventListener("click", payAndGenerateLink);
  $("#btnPay").textContent = "üí≥ Pagar " + PRICE_LABEL + " e gerar link";

  // =========================
  // Gera√ß√£o das cartinhas
  // =========================
  function baseDoc(title, body){
    return `<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>${escHtml(title)}</title>
<style>
  :root{
    --bg1:#0b1020; --bg2:#111a33;
    --text: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.68);
    --stroke: rgba(255,255,255,.16);
    --shadow: 0 18px 50px rgba(0,0,0,.45);
    --r: 22px;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1100px 800px at 25% 20%, #24346b 0%, transparent 60%),
      radial-gradient(1000px 750px at 80% 25%, #6b235e 0%, transparent 55%),
      linear-gradient(135deg, var(--bg1), var(--bg2));
    min-height:100vh;
    padding: 18px 0;
  }
  .card{
    width:min(920px, calc(100% - 32px));
    margin: 0 auto;
    border-radius: var(--r);
    background: rgba(20,20,30,.58);
    border:1px solid var(--stroke);
    box-shadow: var(--shadow);
    backdrop-filter: blur(14px);
    overflow:hidden;
  }
  .h{padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.10);}
  .b{padding:18px;}
  .muted{color:var(--muted); font-size:12px; line-height:1.45}
  .h1{margin:0; font-size:20px;}
</style>
</head>
<body>
${body}
</body>
</html>`;
  }

  function genCartinhaGlass(data, a){
    const title = data.title || "Uma cartinha pra voc√™ ‚ù§Ô∏è";
    const to = data.to || "";
    const msg = data.message || "";
    const from = data.from || "";

    const photo = a.photo;
    const photoSrc = photo ? (photo._dataUrl || "") : "";

    return baseDoc(title, `
      <div class="card">
        <div class="h">
          <div class="h1">${escHtml(title)}</div>
          ${to ? `<div class="muted" style="margin-top:6px;">Para: <b>${escHtml(to)}</b></div>` : ""}
        </div>
        <div class="b">
          ${photoSrc ? `
            <div style="margin-bottom:12px; border-radius:18px; overflow:hidden; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18);">
              <img src="${escAttr(photoSrc)}" alt="" style="width:100%; display:block;">
            </div>
          ` : ""}

          <div style="padding:16px; border-radius:18px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18);">
            <div style="white-space:pre-wrap; line-height:1.75;">${escHtml(msg)}</div>
          </div>

          ${from ? `
            <div style="margin-top:14px; text-align:right; color:rgba(255,255,255,.82);">
              ‚Äî ${escHtml(from)}
            </div>
          ` : ""}
        </div>
      </div>
    `);
  }

  function genCartinhaSimples(data){
    const title = data.title || "Oi, vim deixar isso aqui‚Ä¶";
    const to = data.to || "";
    const msg = data.message || "";
    const from = data.from || "";

    return baseDoc(title, `
      <div class="card">
        <div class="h">
          <div class="h1">${escHtml(title)}</div>
          ${to ? `<div class="muted" style="margin-top:6px;">Para: <b>${escHtml(to)}</b></div>` : ""}
        </div>
        <div class="b">
          <div style="padding:16px; border-radius:18px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18);">
            <div style="white-space:pre-wrap; line-height:1.75;">${escHtml(msg)}</div>
          </div>

          ${from ? `
            <div style="margin-top:14px; text-align:right; color:rgba(255,255,255,.82);">
              ${escHtml(from)}
            </div>
          ` : ""}
        </div>
      </div>
    `);
  }

  // ‚úÖ Tema: Presente Glass + v√≠deo (usa a.videoUrl)
  function genPresenteVideoGlass(data, a){
    const title = (data.title || "Hoje √© dia de comemorar! üéâ").trim();
    const caption = (data.caption || "").trim();
    const videoUrl = (a && a.videoUrl) ? String(a.videoUrl) : "";
    const hasVideo = !!videoUrl;

    const safeTitle = escHtml(title);
    const safeCaption = escHtml(caption);
    const safeVideoUrl = escAttr(videoUrl);

    return `<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéÅ ${safeTitle}</title>
  <style>
    :root{
      --bg1:#050812;
      --bg2:#0b1230;
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --stroke: rgba(255,255,255,.14);
      --shadow: 0 24px 80px rgba(0,0,0,.55);
      --r: 22px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--txt);
      overflow:hidden;
      background:
        radial-gradient(900px 700px at 20% 18%, rgba(120,80,255,.30) 0%, transparent 60%),
        radial-gradient(900px 700px at 82% 22%, rgba(255,90,190,.24) 0%, transparent 62%),
        radial-gradient(1100px 900px at 50% 110%, rgba(70,210,255,.15) 0%, transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
    }

    .stars{
      position:fixed; inset:-30%;
      background-image:
        radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,.45) 40%, transparent 45%),
        radial-gradient(1px 1px at 90px 120px, rgba(255,255,255,.30) 40%, transparent 45%),
        radial-gradient(2px 2px at 210px 80px, rgba(255,255,255,.22) 40%, transparent 45%),
        radial-gradient(1px 1px at 320px 210px, rgba(255,255,255,.18) 40%, transparent 45%),
        radial-gradient(2px 2px at 430px 140px, rgba(255,255,255,.22) 40%, transparent 45%),
        radial-gradient(1px 1px at 520px 260px, rgba(255,255,255,.18) 40%, transparent 45%);
      background-size: 560px 320px;
      opacity:.55;
      animation: drift 18s linear infinite;
      pointer-events:none;
      filter: blur(.2px);
    }
    @keyframes drift{
      from{transform: translate3d(0,0,0)}
      to{transform: translate3d(-120px, 80px, 0)}
    }

    .stage{
      position:fixed;
      inset:0;
      display:grid;
      place-items:center;
      padding:24px;
    }

    .headline{
      position:absolute;
      top:18px;
      left:0; right:0;
      text-align:center;
      pointer-events:none;
      padding: 0 14px;
    }
    .headline h1{
      margin:0;
      font-size: clamp(18px, 3vw, 30px);
      font-weight:900;
      letter-spacing:.2px;
      text-shadow: 0 18px 60px rgba(0,0,0,.60);
    }
    .headline p{
      margin:8px 0 0;
      font-size: clamp(12px, 2vw, 14px);
      color: rgba(255,255,255,.82);
      text-shadow: 0 14px 50px rgba(0,0,0,.55);
      opacity:.95;
      display:${caption ? "block" : "none"};
    }

    .giftWrap{
      position:relative;
      display:grid;
      place-items:center;
      gap:12px;
      cursor:${hasVideo ? "pointer" : "not-allowed"};
      user-select:none;
      transform: translateY(14px);
    }

    .tap{
      font-size:13px;
      color: rgba(255,255,255,.86);
      padding:10px 14px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      max-width:min(520px, 90vw);
      text-align:center;
      opacity:${hasVideo ? "1" : ".75"};
    }

    .gift3d{
      width: 240px;
      height: 240px;
      position:relative;
      transform-style: preserve-3d;
      filter: drop-shadow(0 28px 70px rgba(0,0,0,.55));
      animation: float 3.2s ease-in-out infinite;
      opacity:${hasVideo ? "1" : ".7"};
    }
    @keyframes float{
      0%,100%{transform: translateY(0) rotateX(12deg) rotateY(-12deg)}
      50%{transform: translateY(-10px) rotateX(14deg) rotateY(-8deg)}
    }

    .box{
      position:absolute;
      inset: 24px;
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,.22);
      background:
        linear-gradient(135deg, rgba(255,255,255,.14), rgba(255,255,255,.04));
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .box:before{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.55), transparent 48%);
      transform: rotate(15deg);
      opacity:.35;
    }
    .box:after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(140px 120px at 70% 30%, rgba(255,90,190,.22), transparent 60%),
        radial-gradient(160px 140px at 25% 80%, rgba(70,210,255,.18), transparent 60%);
      opacity:.9;
      mix-blend-mode: screen;
    }

    .lid{
      position:absolute;
      left: 18px; right:18px;
      top: 10px;
      height: 74px;
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.22);
      background:
        linear-gradient(135deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
      backdrop-filter: blur(12px);
      transform-origin: 50% 100%;
      box-shadow: 0 18px 45px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .lid:before{
      content:"";
      position:absolute;
      inset:-60%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.70), transparent 55%);
      transform: rotate(18deg);
      opacity:.35;
    }

    .ribbonV, .ribbonH{ position:absolute; inset:0; pointer-events:none; }
    .ribbonV:before{
      content:"";
      position:absolute;
      top: 12px; bottom: 18px;
      left: 50%;
      width: 18px;
      transform: translateX(-50%);
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,90,190,.95), rgba(70,210,255,.85));
      filter: drop-shadow(0 0 18px rgba(255,90,190,.35));
      opacity:.9;
    }
    .ribbonH:before{
      content:"";
      position:absolute;
      left: 28px; right: 28px;
      top: 50%;
      height: 18px;
      transform: translateY(-50%);
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(70,210,255,.90), rgba(255,90,190,.90));
      filter: drop-shadow(0 0 18px rgba(70,210,255,.30));
      opacity:.9;
    }

    .bow{
      position:absolute;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      width: 86px;
      height: 56px;
      pointer-events:none;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.35));
    }
    .bow:before, .bow:after{
      content:"";
      position:absolute;
      top: 12px;
      width: 38px;
      height: 30px;
      border-radius: 18px 18px 18px 6px;
      background: linear-gradient(135deg, rgba(255,90,190,.95), rgba(70,210,255,.85));
      opacity:.92;
    }
    .bow:before{left:0; transform: rotate(-18deg)}
    .bow:after{right:0; transform: rotate(18deg); border-radius: 18px 18px 6px 18px;}
    .knot{
      position:absolute;
      top: 22px;
      left: 50%;
      transform: translateX(-50%);
      width: 18px;
      height: 18px;
      border-radius: 8px;
      background: rgba(255,255,255,.82);
      opacity:.35;
    }

    .glow{
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at 50% 55%, rgba(255,255,255,.20), transparent 55%);
      opacity:.9;
      pointer-events:none;
    }

    canvas#fx{
      position:absolute;
      inset:-80px;
      width: calc(100% + 160px);
      height: calc(100% + 160px);
      pointer-events:none;
    }

    .opening .lid{ animation: lidPop .65s cubic-bezier(.2,.9,.1,1) forwards; }
    @keyframes lidPop{
      0%{transform: rotateX(0deg) translateY(0)}
      60%{transform: rotateX(55deg) translateY(-12px)}
      100%{transform: rotateX(70deg) translateY(-18px)}
    }
    .opening .gift3d{ animation: punch .75s ease forwards; }
    @keyframes punch{
      0%{transform: translateY(0) rotateX(12deg) rotateY(-12deg) scale(1)}
      50%{transform: translateY(-6px) rotateX(16deg) rotateY(-6deg) scale(1.02)}
      100%{transform: translateY(-2px) rotateX(14deg) rotateY(-10deg) scale(1.00)}
    }

    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.88);
      display:none;
      place-items:center;
      z-index:9999;
      padding:14px;
    }
    .overlay.show{display:grid;}
    .videoBox{
      width:min(1024px, 100%);
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(16,16,22,.72);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(14px);
    }
    .videoTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .videoTop .t{
      font-size:13px;
      color: rgba(255,255,255,.90);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 78vw;
    }
    .btn{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color: var(--txt);
      padding:8px 10px;
      cursor:pointer;
      font-size:13px;
      display:inline-flex; gap:8px; align-items:center;
      text-decoration:none;
    }
    .btn:hover{ background: rgba(255,255,255,.14); }

    video{
      width:100%;
      height: min(78vh, 680px);
      background:#000;
      display:block;
    }

    .warn{
      position:fixed;
      left:14px; right:14px;
      bottom:14px;
      text-align:center;
      font-size:12px;
      color: rgba(255,255,255,.78);
      opacity:${hasVideo ? "0" : "1"};
      pointer-events:none;
    }

    @media (max-width: 980px){
      body{overflow:auto}
      .stage{position:relative; height: calc(100vh - 20px); min-height: 520px;}
      .gift3d{width: 210px; height: 210px;}
      .headline{top: 10px;}
    }
  </style>
</head>
<body>
  <div class="stars"></div>

  <div class="stage" id="stage">
    <div class="headline">
      <h1 id="outTitle">${safeTitle}</h1>
      <p id="outCaption">${safeCaption}</p>
    </div>

    <div class="giftWrap" id="giftWrap" ${hasVideo ? "" : 'aria-disabled="true"'}>
      <div class="gift3d" id="gift3d">
        <canvas id="fx"></canvas>
        <div class="glow"></div>

        <div class="lid" id="lid"></div>

        <div class="box"></div>
        <div class="ribbonV"></div>
        <div class="ribbonH"></div>
        <div class="bow">
          <div class="knot"></div>
        </div>
      </div>

      <div class="tap" id="tapText">${hasVideo ? (caption ? "‚ú® " + safeCaption : "‚ú® Toque / clique no presente") : "‚ö†Ô∏è V√≠deo ainda n√£o foi enviado"}</div>
    </div>
  </div>

  <div class="warn">Selecione e envie um v√≠deo no construtor para este tema funcionar.</div>

  <div class="overlay" id="overlay">
    <div class="videoBox">
      <div class="videoTop">
        <div class="t" id="videoTitle">üé¨ ${safeTitle}</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="btnFullscreen">‚õ∂ Fullscreen</button>
          <button class="btn" id="btnClose">‚úñÔ∏è Fechar</button>
        </div>
      </div>
      <video id="video" ${hasVideo ? `src="${safeVideoUrl}"` : ""} controls playsinline preload="metadata"></video>
    </div>
  </div>

  <script>
    const hasVideo = ${hasVideo ? "true" : "false"};
    if(hasVideo){
      const giftWrap = document.getElementById("giftWrap");
      const gift3d = document.getElementById("gift3d");
      const overlay = document.getElementById("overlay");
      const video = document.getElementById("video");
      const btnClose = document.getElementById("btnClose");
      const btnFullscreen = document.getElementById("btnFullscreen");

      let opening = false;

      const canvas = document.getElementById("fx");
      const ctx = canvas.getContext("2d");
      let W=0,H=0,particles=[];
      function resizeFX(){
        const rect = gift3d.getBoundingClientRect();
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        W = Math.floor(rect.width * dpr);
        H = Math.floor(rect.height * dpr);
        canvas.width = W;
        canvas.height = H;
      }
      window.addEventListener("resize", resizeFX);
      resizeFX();

      function spawnBurst(){
        resizeFX();
        particles = [];
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        const cx = W/2, cy = H/2 + 10*dpr;

        const n = 120;
        for(let i=0;i<n;i++){
          const a = (Math.random()*Math.PI*2);
          const sp = (Math.random()*3.2 + 2.4) * dpr;
          particles.push({
            x: cx,
            y: cy,
            vx: Math.cos(a)*sp,
            vy: Math.sin(a)*sp - (Math.random()*2.2*dpr),
            r: (Math.random()*2.2 + 0.8)*dpr,
            life: 1,
            dl: Math.random()*0.018 + 0.012,
            tw: Math.random()*0.8 + 0.2
          });
        }
        tick();
      }

      function tick(){
        ctx.clearRect(0,0,W,H);
        let alive=0;

        for(const p of particles){
          p.vy += 0.08 * (window.devicePixelRatio||1);
          p.x += p.vx;
          p.y += p.vy;
          p.life -= p.dl;

          if(p.life > 0){
            alive++;
            const alpha = Math.max(0, p.life);
            const glow = (p.tw + Math.sin((1-alpha)*10))*0.5;
            const hue = (p.x / W) * 360;

            ctx.save();
            ctx.globalAlpha = alpha * 0.9;
            ctx.fillStyle = \`hsla(\${hue}, 90%, 65%, \${alpha})\`;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r*(1+glow*0.8), 0, Math.PI*2);
            ctx.fill();

            ctx.globalAlpha = alpha * 0.22;
            ctx.fillStyle = \`hsla(\${hue}, 100%, 85%, \${alpha})\`;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r*2.2*(1+glow), 0, Math.PI*2);
            ctx.fill();
            ctx.restore();
          }
        }

        if(alive>0) requestAnimationFrame(tick);
        else ctx.clearRect(0,0,W,H);
      }

      function tryEnterFullscreen(el){
        try{
          if(el.requestFullscreen) return el.requestFullscreen();
          if(el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
          if(el.webkitEnterFullscreen) return el.webkitEnterFullscreen();
        }catch(e){}
      }

      async function openGift(){
        if(opening) return;
        opening = true;
        giftWrap.classList.add("opening");

        spawnBurst();
        await new Promise(r=>setTimeout(r, 650));

        overlay.classList.add("show");
        video.muted = false;
        video.volume = 1;

        try{ await video.play(); }catch(e){}

        tryEnterFullscreen(video);

        setTimeout(()=> giftWrap.classList.remove("opening"), 400);
        opening = false;
      }

      giftWrap.addEventListener("click", openGift);

      function closeVideo(){
        overlay.classList.remove("show");
        try{ video.pause(); }catch(e){}
        try{
          if(document.fullscreenElement) document.exitFullscreen();
        }catch(e){}
      }

      btnClose.addEventListener("click", closeVideo);
      btnFullscreen.addEventListener("click", ()=> tryEnterFullscreen(video));
      overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeVideo(); });
    }
  <\/script>
</body>
</html>`;
  }

  // ‚úÖ Tema: Convite VIP (v√≠deo opcional)
  function genConviteVIP(data, a){
    const event = (data.event || "Convite VIP ‚Äî Evento Exclusivo").trim();
    const guest = (data.guest || "").trim();
    const date = (data.date || "").trim();
    const time = (data.time || "").trim();
    const place = (data.place || "").trim();
    const address = (data.address || "").trim();
    const dress = (data.dress || "").trim();
    const message = (data.message || "").trim();

    const videoUrl = (a && a.videoUrl) ? String(a.videoUrl) : "";
    const hasVideo = !!videoUrl;

    const mapsUrl = address
      ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`
      : "";

    function makeCode(){
      const seed = `${event}|${guest}|${date}|${time}|${place}|${address}`.toLowerCase();
      let h = 2166136261;
      for(let i=0;i<seed.length;i++){
        h ^= seed.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      const hex = (h >>> 0).toString(16).toUpperCase().padStart(8,"0").slice(0,8);
      return `VIP-${hex}`;
    }
    const code = makeCode();

    const safeEvent = escHtml(event);
    const safeGuest = escHtml(guest);
    const safeDate  = escHtml(date);
    const safeTime  = escHtml(time);
    const safePlace = escHtml(place);
    const safeAddr  = escHtml(address);
    const safeDress = escHtml(dress);
    const safeMsg   = escHtml(message);

    const safeMapsUrl = escAttr(mapsUrl);
    const safeVideoUrl = escAttr(videoUrl);

    const waText =
      `‚úÖ Confirma√ß√£o VIP\n\n` +
      `Evento: ${event}\n` +
      (guest ? `Convidado: ${guest}\n` : "") +
      (date ? `Data: ${date}\n` : "") +
      (time ? `Hora: ${time}\n` : "") +
      (place ? `Local: ${place}\n` : "") +
      (address ? `Endere√ßo: ${address}\n` : "") +
      `\nEstou confirmando minha presen√ßa.`;

    const waUrl = `https://wa.me/?text=${encodeURIComponent(waText)}`;

    return `<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>ü•Ç ${safeEvent}</title>
  <style>
    :root{
      --bg1:#070A12;
      --bg2:#0C1022;
      --panel: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --gold1:#F7D77A;
      --shadow: 0 22px 70px rgba(0,0,0,.55);
      --r: 22px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(900px 700px at 20% 15%, rgba(247,215,122,.18) 0%, transparent 60%),
        radial-gradient(900px 700px at 80% 20%, rgba(140,90,255,.18) 0%, transparent 62%),
        radial-gradient(900px 700px at 50% 110%, rgba(70,210,255,.10) 0%, transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      overflow:hidden;
    }
    .wrap{
      min-height:100%;
      display:grid;
      place-items:center;
      padding: 22px;
    }
    .shell{
      width:min(1040px, 100%);
      border-radius: calc(var(--r) + 6px);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      overflow:hidden;
    }
    .top{
      padding:18px 18px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 240px;
    }
    .title h1{
      margin:0;
      font-size: clamp(18px, 2.6vw, 30px);
      letter-spacing: .2px;
      font-weight: 900;
      line-height:1.12;
    }
    .title .sub{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(247,215,122,.25);
      background: rgba(247,215,122,.08);
      color: rgba(255,255,255,.90);
      font-size:12px;
      white-space:nowrap;
    }
    .badge b{ color: var(--gold1); font-weight:800; }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      padding: 16px;
    }
    .panel{
      border-radius: var(--r);
      border:1px solid var(--stroke);
      background: var(--panel);
      box-shadow: 0 16px 45px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .left{
      padding:16px;
      display:grid;
      gap:12px;
      align-content:start;
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .cell{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:12px;
      min-height: 62px;
    }
    .k{ font-size:11px; color: var(--muted); letter-spacing:.3px; text-transform:uppercase; }
    .v{ margin-top:6px; font-size:14px; font-weight:700; color: rgba(255,255,255,.92); }
    .v.muted{ font-weight:600; color: rgba(255,255,255,.82); }

    .msg{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding:14px;
      line-height:1.55;
      color: rgba(255,255,255,.86);
      white-space:pre-wrap;
      min-height: 96px;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-size:13px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      text-decoration:none;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.12); }
    .btn.primary{
      border-color: rgba(247,215,122,.35);
      background: linear-gradient(135deg, rgba(247,215,122,.18), rgba(215,185,92,.10));
    }
    .btn.primary b{ color: var(--gold1); }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .ticket{
      padding:16px;
      display:grid;
      gap:12px;
      align-content:start;
      position:relative;
    }
    .ticket:before{
      content:"";
      position:absolute;
      inset:-1px;
      background:
        radial-gradient(500px 140px at 30% 10%, rgba(247,215,122,.18), transparent 60%),
        radial-gradient(500px 160px at 70% 0%, rgba(140,90,255,.14), transparent 60%);
      pointer-events:none;
      opacity:.9;
    }

    .card2{
      position:relative;
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      overflow:hidden;
      padding:14px;
    }

    .barcode{
      height: 54px;
      border-radius: 14px;
      background:
        repeating-linear-gradient(
          90deg,
          rgba(255,255,255,.85) 0px,
          rgba(255,255,255,.85) 2px,
          rgba(255,255,255,.10) 2px,
          rgba(255,255,255,.10) 6px
        );
      opacity:.22;
      margin-bottom:12px;
    }

    .ticketRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .code{
      font-weight:900;
      letter-spacing:.6px;
      color: var(--gold1);
      font-size:14px;
      text-align:right;
      white-space:nowrap;
    }
    .status{
      margin-top:6px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(247,215,122,.25);
      background: rgba(247,215,122,.08);
      font-size:12px;
      color: rgba(255,255,255,.88);
      white-space:nowrap;
    }
    .status b{ color: var(--gold1); }

    .small{
      margin-top:8px;
      font-size:12px;
      color: rgba(255,255,255,.70);
      line-height:1.45;
    }

    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.88);
      display:none;
      place-items:center;
      padding:14px;
      z-index:9999;
    }
    .overlay.show{display:grid;}
    .vbox{
      width:min(1024px, 100%);
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(16,16,22,.72);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(14px);
    }
    .vtop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .vtop .t{
      font-size:13px;
      color: rgba(255,255,255,.90);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 78vw;
    }
    video{
      width:100%;
      height: min(78vh, 680px);
      background:#000;
      display:block;
    }

    @media (max-width: 980px){
      body{ overflow:auto; }
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="shell">
      <div class="top">
        <div class="title">
          <h1>${safeEvent}</h1>
          <div class="sub">
            <span class="badge">Acesso <b>VIP</b> ‚Ä¢ Entrada exclusiva</span>
            ${guest ? `<span class="badge">Convidado: <b>${safeGuest}</b></span>` : ``}
          </div>
        </div>
        <div class="badge" title="C√≥digo do ingresso">C√≥digo: <b>${escHtml(code)}</b></div>
      </div>

      <div class="grid">
        <div class="panel">
          <div class="left">
            <div class="kv">
              <div class="cell">
                <div class="k">Data</div>
                <div class="v ${date ? "" : "muted"}">${date ? safeDate : "‚Äî"}</div>
              </div>
              <div class="cell">
                <div class="k">Hora</div>
                <div class="v ${time ? "" : "muted"}">${time ? safeTime : "‚Äî"}</div>
              </div>
              <div class="cell" style="grid-column: 1 / -1;">
                <div class="k">Local</div>
                <div class="v ${place ? "" : "muted"}">${place ? safePlace : "‚Äî"}</div>
              </div>
              <div class="cell" style="grid-column: 1 / -1;">
                <div class="k">Endere√ßo</div>
                <div class="v ${address ? "" : "muted"}">${address ? safeAddr : "‚Äî"}</div>
                ${address ? `<div class="small"><a class="btn" href="${safeMapsUrl}" target="_blank" rel="noopener">üìç Abrir no Maps</a></div>` : ``}
              </div>
              <div class="cell" style="grid-column: 1 / -1;">
                <div class="k">Dress code</div>
                <div class="v ${dress ? "" : "muted"}">${dress ? safeDress : "‚Äî"}</div>
              </div>
            </div>

            ${message ? `<div class="msg">${safeMsg}</div>` : ``}

            <div class="actions">
              <a class="btn primary" href="${escAttr(waUrl)}" target="_blank" rel="noopener">‚úÖ Confirmar presen√ßa (WhatsApp)</a>
              ${hasVideo
                ? `<button class="btn" id="btnTrailer">üé¨ Assistir Trailer (VIP)</button>`
                : `<button class="btn" disabled title="Sem trailer">üé¨ Assistir Trailer (VIP)</button>`
              }
            </div>

            <div class="small">
              Dica: confirme presen√ßa pelo WhatsApp. Se tiver trailer, assista pelo bot√£o VIP.
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="ticket">
            <div class="card2">
              <div class="barcode"></div>
              <div class="ticketRow">
                <div>
                  <div class="k">Ingresso</div>
                  <div class="v">VIP PASS</div>
                  ${guest ? `<div class="small">V√°lido para: <b>${safeGuest}</b></div>` : ``}
                </div>
                <div style="text-align:right;">
                  <div class="k">C√≥digo</div>
                  <div class="code">${escHtml(code)}</div>
                  <div class="status">Status: <b>ATIVO</b></div>
                </div>
              </div>
              <div class="small" style="margin-top:12px;">
                Apresente este ingresso VIP na entrada. Chegue com anteced√™ncia.
              </div>
            </div>

            <div class="small">
              ${hasVideo ? "O trailer abre em overlay (tela cheia pode depender do navegador)." : "Este convite n√£o possui trailer."}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="ov">
    <div class="vbox">
      <div class="vtop">
        <div class="t">üé¨ Trailer VIP</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="btnFs">‚õ∂ Fullscreen</button>
          <button class="btn" id="btnClose">‚úñÔ∏è Fechar</button>
        </div>
      </div>
      <video id="v" ${hasVideo ? `src="${safeVideoUrl}"` : ""} controls playsinline preload="metadata"></video>
    </div>
  </div>

  <script>
    (function(){
      const hasVideo = ${hasVideo ? "true" : "false"};
      if(!hasVideo) return;

      const ov = document.getElementById("ov");
      const v = document.getElementById("v");
      const btnTrailer = document.getElementById("btnTrailer");
      const btnClose = document.getElementById("btnClose");
      const btnFs = document.getElementById("btnFs");

      function tryFs(el){
        try{
          if(el.requestFullscreen) return el.requestFullscreen();
          if(el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
          if(el.webkitEnterFullscreen) return el.webkitEnterFullscreen();
        }catch(e){}
      }

      async function open(){
        ov.classList.add("show");
        try{
          v.muted = false;
          v.volume = 1;
          await v.play();
        }catch(e){}
      }
      function close(){
        ov.classList.remove("show");
        try{ v.pause(); }catch(e){}
        try{ if(document.fullscreenElement) document.exitFullscreen(); }catch(e){}
      }

      btnTrailer && btnTrailer.addEventListener("click", open);
      btnClose.addEventListener("click", close);
      btnFs.addEventListener("click", ()=> tryFs(v));
      ov.addEventListener("click", (e)=>{ if(e.target === ov) close(); });
    })();
  <\/script>
</body>
</html>`;
  }

  function basePreviewEmpty(){
    return baseDoc("Preview", `
      <div class="card">
        <div class="h"><div class="h1">üëà Escolha um tema</div></div>
        <div class="b">
          <div class="muted">Selecione um tema na esquerda pra come√ßar a escrever.</div>
        </div>
      </div>
    `);
  }

  async function autoCheckIfReturnedFromPayment(){
    const sp = new URLSearchParams(location.search);
    const paid = sp.get("paid");
    const id = sp.get("id");
    if(paid !== "1" || !id) return;

    openModal({
      title:"‚è≥ Confirmando pagamento‚Ä¶",
      hint:"Aguarde ‚Äî estamos checando seu link.",
      linkText:"",
      buttons:[]
    });

    const finalUrl = await checkPaidLoop(id);
    if(finalUrl){
      upsertLocalCartinha({ id, status:"approved", finalUrl });
      saveLastLink({ id, url: finalUrl, at: Date.now(), stage:"paid" });

      openModal({
        title:"‚úÖ Link recuperado",
        hint:"Pagamento confirmado. Copie o link (ele tamb√©m ficou salvo no hist√≥rico local):",
        linkText: finalUrl,
        buttons:[
          { label:"üìã Copiar", onClick: async ()=>{ try{ await navigator.clipboard.writeText(finalUrl);}catch(e){} alert("Copiado ‚úÖ"); } },
          { type:"a", label:"üîó Abrir", href: finalUrl },
          { label:"üïò Meus links", onClick: openMyLinksModal }
        ]
      });

      try{ history.replaceState({}, "", location.pathname); }catch(e){}
      renderLocalHistory();
    } else {
      openModal({
        title:"‚ö†Ô∏è Ainda n√£o confirmado",
        hint:"Se voc√™ acabou de pagar, pode levar alguns segundos. Voc√™ pode tentar de novo pelo ‚ÄúMeus links‚Äù.",
        linkText:"",
        buttons:[
          { label:"üïò Meus links", onClick: openMyLinksModal }
        ]
      });
    }
  }

  renderThemes();
  updatePreview();
  renderLocalHistory();
  updateLocalPill();
  refreshPayButtonState();
  autoCheckIfReturnedFromPayment();
</script>
</body>
</html>
