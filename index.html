 <!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Construtor de Cartinhas</title>

  <style>
    :root{
      --bg:#0b1020;
      --panel: rgba(20,20,30,.55);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --r: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1100px 800px at 25% 20%, #24346b 0%, transparent 60%),
        radial-gradient(1000px 750px at 80% 25%, #6b235e 0%, transparent 55%),
        linear-gradient(135deg, #0b1020, #111a33);
      min-height:100vh;
    }
    header{
      padding:18px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; flex-direction:column; gap:4px;}
    .brand h1{margin:0; font-size:16px;}
    .brand p{margin:0; font-size:12px; color:var(--muted)}
    .bar{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center;}

    .wrap{
      padding: 0 18px 18px;
      display:grid;
      grid-template-columns: 390px 1fr;
      gap:14px;
    }
    .card{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .card-h{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .card-h .t{font-size:13px; color:var(--text); opacity:.95}
    .card-b{padding:12px}

    .themes{display:grid; grid-template-columns: 1fr; gap:10px;}
    .theme{
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      display:flex; gap:10px; align-items:flex-start;
      transition: .15s ease;
    }
    .theme:hover{ background: rgba(0,0,0,.26); }
    .theme.active{
      border-color: rgba(255,255,255,.25);
      background: rgba(255,255,255,.08);
    }
    .emoji{font-size:22px; width:32px; text-align:center}
    .theme .name{font-size:13px; margin:0}
    .theme .desc{font-size:12px; color:var(--muted); margin:4px 0 0}

    label{font-size:12px; color:var(--muted)}
    input, textarea{
      width:100%;
      margin-top:6px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding:10px 12px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height: 110px; resize:vertical;}
    .grid{display:grid; gap:10px;}
    .btn{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding:10px 12px;
      cursor:pointer;
      font-size:13px;
      display:inline-flex; gap:8px; align-items:center;
      text-decoration:none;
    }
    .btn:hover{ background: rgba(255,255,255,.14); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .hint{font-size:12px; color:var(--muted); line-height:1.45}
    .sep{height:1px; background: rgba(255,255,255,.10); margin:12px 0;}

    .preview{
      height: calc(100vh - 100px);
      width:100%;
      border:0;
      border-radius: 16px;
      background: rgba(0,0,0,.15);
    }

    .empty{
      padding:16px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.18);
      color:rgba(255,255,255,.75);
      background: rgba(0,0,0,.12);
    }

    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      place-items:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(740px, 100%);
      border-radius: 18px;
      background: rgba(20,20,30,.82);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .modalH{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .modalB{padding:14px;}
    .rowBtns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .linkBox{
      width:100%;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      font-size:13px;
      word-break: break-all;
      white-space: pre-wrap;
    }

    .mini{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
    }
    .mini a{ color:#9bd1ff; text-decoration:none; word-break:break-all }
    .mini a:hover{ text-decoration:underline }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color: rgba(255,255,255,.80);
    }

    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr; }
      .preview{height: 70vh;}
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <h1>üíå Construtor de Cartinhas</h1>
      <p>Escolha um tema, escreva. Pague e gere um link. Se perder, recupere neste mesmo aparelho (hist√≥rico local).</p>
      <div class="hint" style="margin-top:4px;">
        ‚ö†Ô∏è O hist√≥rico local funciona s√≥ neste navegador/aparelho. Se limpar os dados do navegador, ele pode sumir.
      </div>
    </div>

    <div class="bar">
      <span class="pill" id="localCountPill" title="Quantidade de links salvos neste aparelho">üïò 0 salvos</span>
      <button class="btn" id="btnMyLinks">üïò Meus links</button>
      <button class="btn" id="btnPay" disabled>üí≥ Pagar R$ 4,90 e gerar link</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="card-h">
        <div class="t">üé≠ Temas</div>
        <div class="hint">Toque em um tema pra abrir e editar.</div>
      </div>
      <div class="card-b">
        <div class="themes" id="themes"></div>

        <div class="sep"></div>

        <div id="editor" style="display:none;">
          <div class="hint" id="themeHint" style="margin-bottom:10px;"></div>
          <div class="grid" id="form"></div>

          <div class="hint" style="margin-top:10px;">
            No celular: escolha a foto/v√≠deo e aguarde carregar. Se n√£o aparecer no preview, troque e tente de novo.
          </div>

          <div class="mini" id="localHistoryBox" style="display:none;">
            <div class="hint" style="margin:0 0 6px;">üìå √öltimo link salvo neste aparelho:</div>
            <div><a id="localLastLink" href="#" target="_blank" rel="noopener"></a></div>
            <div class="hint" style="margin-top:6px;" id="localLastMeta"></div>
          </div>
        </div>

        <div id="pickTheme" class="empty">
          üëÜ Escolha um tema acima pra come√ßar.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-h">
        <div class="t">üëÄ Preview</div>
        <div class="hint">Atualiza automaticamente</div>
      </div>
      <div class="card-b">
        <iframe class="preview" id="preview" sandbox="allow-same-origin allow-scripts"></iframe>
      </div>
    </div>
  </div>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalH">
        <div style="font-size:13px;" id="modalTitle">‚úÖ</div>
        <button class="btn" id="btnCloseModal">‚úñÔ∏è Fechar</button>
      </div>
      <div class="modalB">
        <div class="hint" id="modalHint"></div>
        <div class="linkBox" id="modalLink" style="margin-top:10px; display:none;"></div>
        <div class="rowBtns" id="modalBtns"></div>
      </div>
    </div>
  </div>

<script>
  const PRICE_LABEL = "R$ 4,90";
  const $ = (s) => document.querySelector(s);

  // =========================
  // LocalStorage (hist√≥rico local)
  // =========================
  const STORAGE_KEY = "cartinhas_local_v1";
  const LAST_KEY  = "cartinhas:last";

  function loadLocalCartinhas(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      return [];
    }
  }
  function saveLocalCartinhas(arr){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr.slice(0, 50)));
    }catch(e){}
  }
  function upsertLocalCartinha(item){
    const arr = loadLocalCartinhas();
    const idx = arr.findIndex(x => x.id === item.id);
    if(idx >= 0){
      arr[idx] = { ...arr[idx], ...item };
    }else{
      arr.unshift(item);
    }
    arr.sort((a,b)=> (new Date(b.createdAt||0)) - (new Date(a.createdAt||0)));
    saveLocalCartinhas(arr);
    updateLocalPill();
  }
  function removeLocalCartinha(id){
    const arr = loadLocalCartinhas().filter(x => x.id !== id);
    saveLocalCartinhas(arr);
    updateLocalPill();
  }
  function updateLocalPill(){
    const n = loadLocalCartinhas().length;
    const pill = $("#localCountPill");
    if(pill) pill.textContent = `üïò ${n} salvos`;
  }

  function saveLastLink(entry){
    const base = { at: Date.now(), ...(entry || {}) };
    if(!base.ts) base.ts = base.at;
    try{ localStorage.setItem(LAST_KEY, JSON.stringify(base)); }catch(e){}
    renderLocalHistory();
  }
  function loadLastLink(){
    try{
      const raw = localStorage.getItem(LAST_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(obj && !obj.at && obj.ts) obj.at = obj.ts;
      if(obj && !obj.ts && obj.at) obj.ts = obj.at;
      return obj;
    }catch(e){ return null; }
  }
  function renderLocalHistory(){
    const box = $("#localHistoryBox");
    if(!box) return;
    const last = loadLastLink();
    if(!last || !last.url){
      box.style.display = "none";
      return;
    }
    box.style.display = "block";
    $("#localLastLink").href = last.url;
    $("#localLastLink").textContent = last.url;
    $("#localLastMeta").textContent =
      `Tema: ${last.theme || "-"} ‚Ä¢ ${new Date(last.at || last.ts || Date.now()).toLocaleString("pt-BR")}`;
  }

  function formatDateBR(iso){
    try{ return new Date(iso).toLocaleString("pt-BR"); }
    catch(e){ return iso || ""; }
  }

  function escHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (m)=>( {
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m] ));
  }
  function escAttr(s){
    return String(s ?? "").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }
  function readFileAsDataURL(file){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = () => resolve(String(r.result));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  // =========================
  // Upload de v√≠deo para Vercel Blob (via /api/upload)
  // =========================
  async function uploadVideoToBlob(file){
    // Importa o client do Blob no browser (sem bundler)
    const mod = await import("https://esm.sh/@vercel/blob/client");
    const upload = mod.upload;

    const ext = (String(file.name || "").split(".").pop() || "mp4").toLowerCase();
    const path = `cartinhas/videos/${Date.now()}_${Math.random().toString(16).slice(2)}.${ext}`;

    const blob = await upload(path, file, {
      access: "public",
      handleUploadUrl: "/api/upload"
    });

    if(!blob || !blob.url) throw new Error("Upload n√£o retornou URL.");
    return blob.url;
  }

  function makeField(field, value, onChange){
    const wrap = document.createElement("div");
    const id = "f_" + field.key;

    wrap.innerHTML = `<label for="${id}">${escHtml(field.label)}</label>`;

    let el;
    if(field.type === "textarea"){
      el = document.createElement("textarea");
      el.id = id;
      el.value = value ?? "";
      if(field.placeholder) el.placeholder = field.placeholder;
    } else if(field.type === "file"){
      el = document.createElement("input");
      el.id = id;
      el.type = "file";
      el.accept = field.accept || "";
    } else {
      el = document.createElement("input");
      el.id = id;
      el.type = "text";
      el.value = value ?? "";
      if(field.placeholder) el.placeholder = field.placeholder;
    }

    el.addEventListener("input", () => onChange(field, el));
    el.addEventListener("change", () => onChange(field, el));
    wrap.appendChild(el);

    // Sempre cria um "help" em file (pra mostrar status de upload tamb√©m)
    if(field.help || field.type === "file"){
      const h = document.createElement("div");
      h.className = "hint";
      h.style.marginTop = "6px";
      h.id = "help_" + field.key; // ex: help_video
      h.textContent = field.help || "";
      wrap.appendChild(h);
    }

    return wrap;
  }

  function setHelp(key, text){
    const el = document.getElementById("help_" + key);
    if(el) el.textContent = text || "";
  }

  function openModal({ title, hint, linkText, buttons }){
    $("#modalTitle").textContent = title || "‚úÖ";
    $("#modalHint").textContent = hint || "";
    const linkBox = $("#modalLink");
    const btns = $("#modalBtns");

    btns.innerHTML = "";

    if(linkText){
      linkBox.style.display = "block";
      linkBox.textContent = linkText;
    } else {
      linkBox.style.display = "none";
      linkBox.textContent = "";
    }

    (buttons || []).forEach(b=>{
      if(b.type === "a"){
        const a = document.createElement("a");
        a.className = "btn";
        a.textContent = b.label;
        a.href = b.href || "#";
        a.target = b.target || "_blank";
        a.rel = "noopener";
        btns.appendChild(a);
      } else {
        const bt = document.createElement("button");
        bt.className = "btn";
        bt.textContent = b.label;
        bt.onclick = b.onClick;
        btns.appendChild(bt);
      }
    });

    $("#modalBack").style.display = "grid";
  }
  function closeModal(){ $("#modalBack").style.display = "none"; }

  $("#btnCloseModal").addEventListener("click", closeModal);
  $("#modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") closeModal(); });

  function makeMyLinksHtml(){
    const items = loadLocalCartinhas();
    if(!items.length){
      return `<div class="hint">Nenhum link salvo neste aparelho ainda.</div>`;
    }

    return `
      <div class="hint" style="margin-bottom:10px;">
        Estes links ficam salvos <b>somente neste aparelho/navegador</b>.
      </div>
      <div style="display:grid; gap:10px;">
        ${items.map(it=>{
          const status = it.finalUrl ? "‚úÖ aprovado" : "‚è≥ pendente";
          const primary = it.finalUrl || it.checkoutUrl || "";
          const title = it.title || `Cartinha (${it.theme||"tema"})`;
          return `
            <div style="border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.18); border-radius:16px; padding:12px;">
              <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
                <div style="min-width:0;">
                  <div style="font-size:13px; font-weight:600;">${escHtml(title)}</div>
                  <div class="hint" style="margin-top:4px;">
                    ${status} ‚Ä¢ ${escHtml(formatDateBR(it.createdAt))}
                  </div>
                  <div class="hint" style="margin-top:6px; word-break:break-all;">
                    ${escHtml(primary)}
                  </div>
                </div>
                <button class="btn" data-del="${escAttr(it.id)}" title="Remover do hist√≥rico">üóëÔ∏è</button>
              </div>

              <div class="rowBtns" style="margin-top:10px;">
                ${primary ? `<a class="btn" href="${escAttr(primary)}" target="_blank" rel="noopener">üîó Abrir</a>` : ""}
                ${primary ? `<button class="btn" data-copy="${escAttr(primary)}">üìã Copiar</button>` : ""}
                ${!it.finalUrl ? `<button class="btn" data-check="${escAttr(it.id)}">üîÑ Verificar pagamento</button>` : ""}
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  async function checkAndUpdateOne(id){
    const res = await fetch("/api/status?id=" + encodeURIComponent(id));
    const j = await res.json().catch(()=> ({}));
    if(res.ok && j && j.url){
      upsertLocalCartinha({ id, finalUrl: j.url, status: "approved" });
      saveLastLink({ id, url: j.url, at: Date.now(), stage:"paid" });
      return j.url;
    }
    return null;
  }

  function openMyLinksModal(){
    openModal({ title: "üïò Links salvos neste aparelho", hint: "", linkText: "", buttons: [] });

    const hintEl = $("#modalHint");
    hintEl.innerHTML = makeMyLinksHtml();

    hintEl.querySelectorAll("[data-copy]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const v = btn.getAttribute("data-copy");
        try{ await navigator.clipboard.writeText(v); }catch(e){}
        alert("Copiado ‚úÖ");
      });
    });

    hintEl.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-del");
        removeLocalCartinha(id);
        hintEl.innerHTML = makeMyLinksHtml();
      });
    });

    hintEl.querySelectorAll("[data-check]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-check");
        btn.disabled = true;
        btn.textContent = "‚è≥ verificando...";
        try{
          const url = await checkAndUpdateOne(id);
          alert(url ? "Aprovado ‚úÖ Link atualizado!" : "Ainda pendente. Tente novamente em alguns segundos.");
        }catch(e){
          alert("Erro ao verificar.");
        }finally{
          btn.disabled = false;
          btn.textContent = "üîÑ Verificar pagamento";
          hintEl.innerHTML = makeMyLinksHtml();
        }
      });
    });
  }

  $("#btnMyLinks").addEventListener("click", openMyLinksModal);

  // =========================
  // THEMES (inclui Presente + V√≠deo)
  // =========================
  const THEMES = {
    amor: {
      emoji: "üíå",
      name: "Cartinha de Amor",
      desc: "Carta glass + foto opcional.",
      hint: "Ideal pra mandar por link (ap√≥s pagamento Pix).",
      fields: [
        { key:"title", label:"T√≠tulo", placeholder:"Uma cartinha pra voc√™ ‚ù§Ô∏è" },
        { key:"to", label:"Para", placeholder:"Meu amor" },
        { key:"message", label:"Mensagem", type:"textarea", placeholder:"Escreva aqui sua mensagem..." },
        { key:"from", label:"Assinatura", placeholder:"Seu nome" },
        { key:"photo", label:"Foto (opcional)", type:"file", accept:"image/*", help:"Aparece no topo da cartinha." }
      ],
      generate: (data, asset, mode) => genCartinhaGlass(data, asset, mode)
    },

    simples: {
      emoji: "‚úâÔ∏è",
      name: "Cartinha Simples",
      desc: "Sem foto, s√≥ texto (bem direto).",
      hint: "Perfeita pra algo r√°pido.",
      fields: [
        { key:"title", label:"T√≠tulo", placeholder:"Oi, vim deixar isso aqui..." },
        { key:"to", label:"Para", placeholder:"Fulano/Fulana" },
        { key:"message", label:"Mensagem", type:"textarea", placeholder:"Escreva aqui..." },
        { key:"from", label:"Assinatura", placeholder:"Seu nome" }
      ],
      generate: (data) => genCartinhaSimples(data)
    },

    presenteVideo: {
      emoji: "üéÅ",
      name: "Presente + V√≠deo",
      desc: "Presente no centro ‚Üí abre e toca v√≠deo com √°udio.",
      hint: "Escolha um v√≠deo (at√© 25MB). Depois, quem receber clica no presente para abrir e tocar.",
      fields: [
        { key:"title", label:"T√≠tulo", placeholder:"Uma surpresa pra voc√™ üéÅ" },
        { key:"caption", label:"Legenda (opcional)", placeholder:"Clique no presente..." },
        { key:"video", label:"V√≠deo (at√© 25MB)", type:"file", accept:"video/*", help:"O v√≠deo ser√° enviado e ficar√° p√∫blico." }
      ],
      generate: (data, asset, mode) => genPresenteVideo(data, asset, mode)
    }
  };

  let themeId = null;

  const state = {
    amor: {
      title: "Uma cartinha pra voc√™ ‚ù§Ô∏è",
      to: "Meu amor",
      message: "Escreva aqui sua mensagem...\n\nCom carinho,\nEu ‚ù§Ô∏è",
      from: "Seu nome"
    },
    simples: {
      title: "Oi, vim deixar isso aqui‚Ä¶",
      to: "Voc√™",
      message: "Escreva aqui sua mensagem...",
      from: "‚Äî Seu nome"
    },
    presenteVideo: {
      title: "Uma surpresa pra voc√™ üéÅ",
      caption: "Clique no presente para abrir"
    }
  };

  const assets = {
    amor: { photo: null },
    simples: {},
    presenteVideo: { videoFile: null, videoUrl: "" }
  };

  function refreshPayButtonState(){
    const pay = $("#btnPay");
    if(!themeId){
      pay.disabled = true;
      return;
    }

    // Para Presente+V√≠deo: s√≥ libera pagar quando tiver URL do v√≠deo
    if(themeId === "presenteVideo"){
      pay.disabled = !assets.presenteVideo.videoUrl;
      return;
    }

    pay.disabled = false;
  }

  function renderThemes(){
    const root = $("#themes");
    root.innerHTML = "";

    Object.entries(THEMES).forEach(([id, t])=>{
      const el = document.createElement("div");
      el.className = "theme" + (id === themeId ? " active" : "");
      el.innerHTML = `
        <div class="emoji">${t.emoji}</div>
        <div>
          <p class="name">${escHtml(t.name)}</p>
          <p class="desc">${escHtml(t.desc)}</p>
        </div>
      `;
      el.addEventListener("click", ()=>{
        themeId = id;
        $("#editor").style.display = "block";
        $("#pickTheme").style.display = "none";

        renderThemes();
        renderForm();
        updatePreview();
        renderLocalHistory();
        refreshPayButtonState();
      });
      root.appendChild(el);
    });
  }

  function renderForm(){
    const t = THEMES[themeId];
    const data = state[themeId] || (state[themeId] = {});
    $("#themeHint").textContent = t.hint || "";

    const form = $("#form");
    form.innerHTML = "";

    t.fields.forEach(field=>{
      const el = makeField(field, data[field.key], async (field, inputEl)=>{
        if(field.type === "file"){
          const f = inputEl.files && inputEl.files[0] ? inputEl.files[0] : null;

          // FOTO (tema amor)
          if(themeId === "amor" && field.key === "photo"){
            assets.amor.photo = f;
            if(assets.amor.photo){
              assets.amor.photo._dataUrl = await readFileAsDataURL(assets.amor.photo);
            }
            updatePreview();
            refreshPayButtonState();
            return;
          }

          // V√çDEO (tema presenteVideo) -> sobe pro Blob e salva URL
          if(themeId === "presenteVideo" && field.key === "video"){
            if(!f){
              assets.presenteVideo.videoFile = null;
              assets.presenteVideo.videoUrl = "";
              setHelp("video", "O v√≠deo ser√° enviado e ficar√° p√∫blico.");
              updatePreview();
              refreshPayButtonState();
              return;
            }

            const MAX = 25 * 1024 * 1024; // 25MB
            if(f.size > MAX){
              assets.presenteVideo.videoFile = null;
              assets.presenteVideo.videoUrl = "";
              inputEl.value = "";
              setHelp("video", "‚ùå V√≠deo muito grande. Limite: 25MB.");
              alert("V√≠deo muito grande. Limite: 25MB.");
              updatePreview();
              refreshPayButtonState();
              return;
            }

            setHelp("video", "‚è≥ Enviando v√≠deo‚Ä¶ (n√£o feche a p√°gina)");

            try{
              const url = await uploadVideoToBlob(f);
              assets.presenteVideo.videoFile = f;
              assets.presenteVideo.videoUrl = url;
              setHelp("video", "‚úÖ V√≠deo enviado! Agora o presente vai abrir o v√≠deo.");
            }catch(err){
              console.error("Falha no upload do v√≠deo:", err);
              assets.presenteVideo.videoFile = null;
              assets.presenteVideo.videoUrl = "";
              inputEl.value = "";
              setHelp("video", "‚ùå Falha no upload. Abra o console (F12) para ver o erro.");
              alert("Falha no upload do v√≠deo. Abra o console (F12) para ver o erro.");
            }

            updatePreview();
            refreshPayButtonState();
            return;
          }

          // Qualquer outro file (se tiver no futuro)
          updatePreview();
          refreshPayButtonState();
          return;
        }

        // Campos de texto
        data[field.key] = inputEl.value;
        updatePreview();
        refreshPayButtonState();
      });

      form.appendChild(el);
    });

    // Atualiza ajuda inicial quando entra no tema presenteVideo
    if(themeId === "presenteVideo"){
      setHelp("video", assets.presenteVideo.videoUrl
        ? "‚úÖ V√≠deo j√° enviado (salvo nesta sess√£o)."
        : "O v√≠deo ser√° enviado e ficar√° p√∫blico."
      );
    }
  }

  function updatePreview(){
    if(!themeId){
      $("#preview").srcdoc = basePreviewEmpty();
      return;
    }
    const t = THEMES[themeId];
    const data = state[themeId] || {};
    const html = t.generate(data, assets[themeId], "preview");
    $("#preview").srcdoc = html;
  }

  async function checkPaidLoop(id){
    const maxTries = 40;
    for(let i=0;i<maxTries;i++){
      await new Promise(r=>setTimeout(r, 3000));
      try{
        const res = await fetch("/api/status?id=" + encodeURIComponent(id));
        const j = await res.json().catch(()=> ({}));
        if(res.ok && j.paid && j.url) return j.url;
      }catch(e){}
    }
    return null;
  }

  async function readErrorBody(resp){
    const ct = resp.headers.get("content-type") || "";
    if(ct.includes("application/json")){
      const j = await resp.json().catch(()=> ({}));
      return JSON.stringify(j, null, 2);
    }
    const t = await resp.text().catch(()=> "");
    return t || `HTTP ${resp.status}`;
  }

  async function payAndGenerateLink(){
    if(!themeId) return;

    // trava se for presenteVideo e n√£o tiver v√≠deo
    if(themeId === "presenteVideo" && !assets.presenteVideo.videoUrl){
      alert("Selecione e envie um v√≠deo (at√© 25MB) antes de gerar o link.");
      return;
    }

    const t = THEMES[themeId];
    const data = state[themeId] || {};
    const html = t.generate(data, assets[themeId], "publish");

    const btn = $("#btnPay");
    btn.disabled = true;
    btn.textContent = "‚è≥ Criando pagamento...";

    try{
      const r = await fetch("/api/publish", {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ theme: themeId, html })
      });

      if(!r.ok){
        const details = await readErrorBody(r);
        openModal({
          title: "‚ùå Erro no servidor (publish)",
          hint: "Detalhes abaixo (resposta da API):",
          linkText: details,
          buttons: []
        });
        return;
      }

      const j = await r.json().catch(()=> ({}));
      const checkoutUrl = j.checkout_url;
      const id = j.id;

      if(!checkoutUrl || !id){
        openModal({
          title: "‚ùå Resposta inesperada",
          hint: "A API respondeu OK, mas n√£o veio checkout_url/id.",
          linkText: JSON.stringify(j, null, 2),
          buttons: []
        });
        return;
      }

      upsertLocalCartinha({
        id,
        createdAt: new Date().toISOString(),
        theme: themeId,
        status: "pending",
        checkoutUrl,
        finalUrl: null,
        title: (state[themeId]?.title || `Cartinha (${themeId})`)
      });

      openModal({
        title: "üí≥ Pague no Pix para liberar o link",
        hint: "Abra o pagamento, conclua no Pix e depois clique em ‚ÄúJ√° paguei‚Äù. (O pedido ficou salvo no hist√≥rico local.)",
        linkText: checkoutUrl,
        buttons: [
          { type:"a", label:"üîó Abrir pagamento", href: checkoutUrl },
          { label:"üìã Copiar link do pagamento", onClick: async ()=>{
              try{ await navigator.clipboard.writeText(checkoutUrl);}catch(e){}
              alert("Copiado ‚úÖ");
            }
          },
          { label:"üïò Ver meus links", onClick: openMyLinksModal },
          { label:"‚úÖ J√° paguei ‚Äî verificar", onClick: async ()=>{
              openModal({ title:"‚è≥ Verificando pagamento‚Ä¶", hint:"Pode levar alguns segundos.", linkText:"", buttons: [] });
              const finalUrl = await checkPaidLoop(id);
              if(finalUrl){
                upsertLocalCartinha({ id, status:"approved", finalUrl });
                saveLastLink({ id, url: finalUrl, at: Date.now(), stage:"paid", theme: themeId });

                openModal({
                  title: "‚úÖ Link gerado",
                  hint: "Copie e mande no WhatsApp/Instagram. Ele tamb√©m ficou salvo no hist√≥rico local deste aparelho.",
                  linkText: finalUrl,
                  buttons: [
                    { label:"üìã Copiar", onClick: async ()=>{ try{ await navigator.clipboard.writeText(finalUrl);}catch(e){} alert("Copiado ‚úÖ"); } },
                    { type:"a", label:"üîó Abrir", href:finalUrl },
                    { type:"a", label:"üí¨ WhatsApp", href:"https://wa.me/?text="+encodeURIComponent(finalUrl) },
                    { label:"üïò Meus links", onClick: openMyLinksModal }
                  ]
                });

                renderLocalHistory();
              } else {
                openModal({
                  title: "‚ö†Ô∏è Ainda n√£o confirmou",
                  hint: "Se pagou agora, espere um pouco e tente novamente. Voc√™ tamb√©m pode ver em ‚ÄúMeus links‚Äù.",
                  linkText: "",
                  buttons: [
                    { type:"a", label:"üîó Abrir pagamento", href: checkoutUrl },
                    { label:"üïò Meus links", onClick: openMyLinksModal }
                  ]
                });
              }
            }
          }
        ]
      });

    }catch(e){
      openModal({
        title: "‚ùå Erro",
        hint: "Falha inesperada no navegador:",
        linkText: String(e?.message || e),
        buttons: []
      });
    }finally{
      btn.textContent = "üí≥ Pagar " + PRICE_LABEL + " e gerar link";
      refreshPayButtonState();
    }
  }

  $("#btnPay").addEventListener("click", payAndGenerateLink);
  $("#btnPay").textContent = "üí≥ Pagar " + PRICE_LABEL + " e gerar link";

  // =========================
  // Gera√ß√£o das cartinhas
  // =========================
  function baseDoc(title, body){
    return `<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>${escHtml(title)}</title>
<style>
  :root{
    --bg1:#0b1020; --bg2:#111a33;
    --text: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.68);
    --stroke: rgba(255,255,255,.16);
    --shadow: 0 18px 50px rgba(0,0,0,.45);
    --r: 22px;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1100px 800px at 25% 20%, #24346b 0%, transparent 60%),
      radial-gradient(1000px 750px at 80% 25%, #6b235e 0%, transparent 55%),
      linear-gradient(135deg, var(--bg1), var(--bg2));
    min-height:100vh;
    padding: 18px 0;
  }
  .card{
    width:min(920px, calc(100% - 32px));
    margin: 0 auto;
    border-radius: var(--r);
    background: rgba(20,20,30,.58);
    border:1px solid var(--stroke);
    box-shadow: var(--shadow);
    backdrop-filter: blur(14px);
    overflow:hidden;
  }
  .h{padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.10);}
  .b{padding:18px;}
  .muted{color:var(--muted); font-size:12px; line-height:1.45}
  .h1{margin:0; font-size:20px;}
</style>
</head>
<body>
${body}
</body>
</html>`;
  }

  function genCartinhaGlass(data, a){
    const title = data.title || "Uma cartinha pra voc√™ ‚ù§Ô∏è";
    const to = data.to || "";
    const msg = data.message || "";
    const from = data.from || "";

    const photo = a.photo;
    const photoSrc = photo ? (photo._dataUrl || "") : "";

    return baseDoc(title, `
      <div class="card">
        <div class="h">
          <div class="h1">${escHtml(title)}</div>
          ${to ? `<div class="muted" style="margin-top:6px;">Para: <b>${escHtml(to)}</b></div>` : ""}
        </div>
        <div class="b">
          ${photoSrc ? `
            <div style="margin-bottom:12px; border-radius:18px; overflow:hidden; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18);">
              <img src="${escAttr(photoSrc)}" alt="" style="width:100%; display:block;">
            </div>
          ` : ""}

          <div style="padding:16px; border-radius:18px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18);">
            <div style="white-space:pre-wrap; line-height:1.75;">${escHtml(msg)}</div>
          </div>

          ${from ? `
            <div style="margin-top:14px; text-align:right; color:rgba(255,255,255,.82);">
              ‚Äî ${escHtml(from)}
            </div>
          ` : ""}
        </div>
      </div>
    `);
  }

  function genCartinhaSimples(data){
    const title = data.title || "Oi, vim deixar isso aqui‚Ä¶";
    const to = data.to || "";
    const msg = data.message || "";
    const from = data.from || "";

    return baseDoc(title, `
      <div class="card">
        <div class="h">
          <div class="h1">${escHtml(title)}</div>
          ${to ? `<div class="muted" style="margin-top:6px;">Para: <b>${escHtml(to)}</b></div>` : ""}
        </div>
        <div class="b">
          <div style="padding:16px; border-radius:18px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18);">
            <div style="white-space:pre-wrap; line-height:1.75;">${escHtml(msg)}</div>
          </div>

          ${from ? `
            <div style="margin-top:14px; text-align:right; color:rgba(255,255,255,.82);">
              ${escHtml(from)}
            </div>
          ` : ""}
        </div>
      </div>
    `);
  }

  function genPresenteVideo(data, a){
    const title = data.title || "Uma surpresa pra voc√™ üéÅ";
    const caption = data.caption || "";
    const videoUrl = (a && a.videoUrl) ? a.videoUrl : "";
    const needsVideo = !videoUrl;

    return baseDoc(title, `
      <div class="card">
        <div class="h">
          <div class="h1">${escHtml(title)}</div>
          <div class="muted" style="margin-top:6px;">
            ${needsVideo ? "‚ö†Ô∏è V√≠deo ainda n√£o foi enviado." : "üéÅ Clique no presente para abrir e tocar o v√≠deo."}
          </div>
        </div>

        <div class="b">
          <div style="
            height: 70vh;
            display:flex;
            align-items:center;
            justify-content:center;
            position:relative;
            border-radius: 22px;
            border:1px solid rgba(255,255,255,.12);
            background: rgba(0,0,0,.14);
            overflow:hidden;
          ">
            ${caption ? `
              <div style="
                position:absolute;
                top:16px;
                left:16px;
                right:16px;
                text-align:center;
                font-size:16px;
                color: rgba(255,255,255,.92);
                text-shadow: 0 10px 25px rgba(0,0,0,.45);
              ">${escHtml(caption)}</div>
            ` : ""}

            <button id="giftBtn" ${needsVideo ? "disabled" : ""} style="
              width:180px; height:180px;
              border-radius: 26px;
              border: 1px solid rgba(255,255,255,.18);
              background: rgba(255,255,255,.08);
              cursor: ${needsVideo ? "not-allowed" : "pointer"};
              box-shadow: 0 18px 60px rgba(0,0,0,.45);
              display:grid; place-items:center;
              font-size:72px;
              transition: transform .15s ease;
            ">üéÅ</button>

            <div id="boom" style="
              position:absolute; inset:0;
              display:none;
              place-items:center;
              pointer-events:none;
            ">
              <div style="
                width:12px; height:12px;
                border-radius:999px;
                box-shadow:
                  0 0 0 0 rgba(255,255,255,.85),
                  0 0 0 0 rgba(255,255,255,.55);
                animation: pop .8s ease forwards;
              "></div>
            </div>

            <div id="fs" style="
              position:fixed; inset:0;
              background:#000;
              display:none;
              align-items:center;
              justify-content:center;
              z-index:999999;
            ">
              <video id="v" src="${escAttr(videoUrl)}" playsinline controls style="width:100%; height:100%; object-fit:contain;"></video>
              <button id="close" style="
                position:fixed; top:14px; right:14px;
                border-radius: 14px;
                border:1px solid rgba(255,255,255,.22);
                background: rgba(255,255,255,.12);
                color:#fff;
                padding:10px 12px;
                cursor:pointer;
                font-size:14px;
              ">‚úñÔ∏è Fechar</button>
            </div>

            <style>
              @keyframes pop{
                0%{ transform: scale(1); opacity:1; box-shadow: 0 0 0 0 rgba(255,255,255,.85), 0 0 0 0 rgba(255,255,255,.55); }
                100%{ transform: scale(1); opacity:0; box-shadow: 0 0 0 380px rgba(255,255,255,0), 0 0 0 680px rgba(255,255,255,0); }
              }
            </style>

            <script>
              (function(){
                const disabled = ${needsVideo ? "true" : "false"};
                if(disabled) return;

                const btn = document.getElementById("giftBtn");
                const boom = document.getElementById("boom");
                const fs = document.getElementById("fs");
                const v = document.getElementById("v");
                const close = document.getElementById("close");

                async function openVideo(){
                  boom.style.display = "grid";
                  btn.style.transform = "scale(0.92)";

                  setTimeout(async ()=>{
                    fs.style.display = "flex";

                    // tenta fullscreen (pode falhar no preview por causa do iframe sandbox)
                    try{
                      if(fs.requestFullscreen) await fs.requestFullscreen();
                    }catch(e){}

                    // tenta tocar com √°udio (permitido porque veio do clique)
                    try{
                      v.muted = false;
                      v.volume = 1;
                      await v.play();
                    }catch(e){
                      // se bloquear, o usu√°rio d√° play no controls
                    }
                  }, 450);
                }

                function closeVideo(){
                  try{ v.pause(); }catch(e){}
                  fs.style.display = "none";
                  boom.style.display = "none";
                  btn.style.transform = "scale(1)";
                  try{
                    if(document.fullscreenElement) document.exitFullscreen();
                  }catch(e){}
                }

                btn.addEventListener("click", openVideo);
                close.addEventListener("click", closeVideo);
                fs.addEventListener("click", (e)=>{ if(e.target === fs) closeVideo(); });
              })();
            <\/script>
          </div>
        </div>
      </div>
    `);
  }

  function basePreviewEmpty(){
    return baseDoc("Preview", `
      <div class="card">
        <div class="h"><div class="h1">üëà Escolha um tema</div></div>
        <div class="b">
          <div class="muted">Selecione um tema na esquerda pra come√ßar a escrever.</div>
        </div>
      </div>
    `);
  }

  async function autoCheckIfReturnedFromPayment(){
    const sp = new URLSearchParams(location.search);
    const paid = sp.get("paid");
    const id = sp.get("id");
    if(paid !== "1" || !id) return;

    openModal({
      title:"‚è≥ Confirmando pagamento‚Ä¶",
      hint:"Aguarde ‚Äî estamos checando seu link.",
      linkText:"",
      buttons:[]
    });

    const finalUrl = await checkPaidLoop(id);
    if(finalUrl){
      upsertLocalCartinha({ id, status:"approved", finalUrl });
      saveLastLink({ id, url: finalUrl, at: Date.now(), stage:"paid" });

      openModal({
        title:"‚úÖ Link recuperado",
        hint:"Pagamento confirmado. Copie o link (ele tamb√©m ficou salvo no hist√≥rico local):",
        linkText: finalUrl,
        buttons:[
          { label:"üìã Copiar", onClick: async ()=>{ try{ await navigator.clipboard.writeText(finalUrl);}catch(e){} alert("Copiado ‚úÖ"); } },
          { type:"a", label:"üîó Abrir", href: finalUrl },
          { label:"üïò Meus links", onClick: openMyLinksModal }
        ]
      });

      try{ history.replaceState({}, "", location.pathname); }catch(e){}
      renderLocalHistory();
    } else {
      openModal({
        title:"‚ö†Ô∏è Ainda n√£o confirmado",
        hint:"Se voc√™ acabou de pagar, pode levar alguns segundos. Voc√™ pode tentar de novo pelo ‚ÄúMeus links‚Äù.",
        linkText:"",
        buttons:[
          { label:"üïò Meus links", onClick: openMyLinksModal }
        ]
      });
    }
  }

  renderThemes();
  updatePreview();
  renderLocalHistory();
  updateLocalPill();
  refreshPayButtonState();
  autoCheckIfReturnedFromPayment();
</script>
</body>
</html>

